codecov: true
language: python
dist: trusty
compiler:
  - gcc
os:
  - linux
  # - osx
env:
  global:
    - OMPI_MCA_rmaps_base_oversubscribe=true
    # - MINICONDA_VERSION="latest"
    # - MINICONDA_PYTHON_MAJOR=3
    # - MINICONDA_LINUX="Linux-x86_64"
    # - MINICONDA_OSX="MacOSX-x86_64"
  matrix:
    # - PYTHON_VERSION=3.5
    # - PYTHON_VERSION=3.6
    - PYTHON_VERSION=3.7

addons:
  apt:
    packages:
      - build-essential
      - python-dev
      - gfortran
      - libgsl0-dev
      - cmake
      - libfftw3-3
      - libfftw3-dev
      - libmpfr4
      - libmpfr-dev
      - libhdf5-serial-dev
      - hdf5-tools
      - libmpich-dev
      - mpich
      # - libopenmpi-dev
      # - openmpi-bin
  homebrew:
    packages:
      - openmpi


before_install:
  # - if [[ $TRAVIS_OS_NAME == linux ]]; then ; fi
  # - if [[ $TRAVIS_OS_NAME == osx ]]; then
  #     something;
  #   fi
  # - pip install --upgrade pip
  - which pip
  - pip install numpy scipy matplotlib nose docutils mpi4py h5py Cython
  - pip install pytest-cov codecov

install:
  - pip install -e .
  - ./configure
  - make framework

virtualenv:
  system_site_packages: false

script:
- export PYTHONPATH=${PWD}/src:${PWD}
- |
  if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then
    # mpiexec -n 1 nosetests --with-coverage amuse.test.suite.compile_tests.test_python_implementation:TestInterface.test10 -sv || exit $?
    mpiexec -n 1 py.test --cov-report=xml --cov=amuse test/compile_tests/test_python_implementation.py -k "TestInterface.test10"
    # mpiexec -n 1 nosetests --with-coverage test/reports/test_speed.py -sv || exit $?
    mpiexec -n 1 py.test --cov-report=xml --cov=amuse test/reports/test_speed.py
    # mpiexec -n 1 nosetests --with-coverage -e "test_plot" test/core_tests || exit $?
    mpiexec -n 1 py.test --cov-report=xml --cov=amuse test/core_tests -k "not test_plot"
    # mpiexec -n 1 nosetests --with-coverage -e "test_cython_implementation" test/compile_tests -sv || exit $?
    mpiexec .n 1 py.test --cov-report=xml --cov=amuse test/compile_tests -k "not test_cython_implementation"
  elif [[ "$TRAVIS_OS_NAME" == "osx" ]]; then
    nosetests --with-coverage test/reports/test_speed.py -sv
    nosetests --with-coverage -e "test_plot" test/core_tests
    nosetests --with-coverage test/compile_tests/test_c_implementation.py -sv
    #nosetests --with-coverage test/compile_tests/test_c_sockets_implementation.py -sv
    nosetests --with-coverage test/compile_tests/test_fortran_implementation.py -sv
    #nosetests --with-coverage test/compile_tests/test_fortran_sockets_implementation.py -sv
    nosetests --with-coverage test/compile_tests/test_python_implementation.py -sv
  fi
  
after_success:
  - codecov
