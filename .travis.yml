codecov: true
language: c
compiler:
  - gcc
os:
  #- linux
  - osx
dist: bionic
osx_image: xcode11.5
env:
  global:
    - OMPI_MCA_rmaps_base_oversubscribe=true
    - MINICONDA_VERSION="latest"
    - MINICONDA_PYTHON_MAJOR=3
    - MINICONDA_LINUX="Linux-x86_64"
    - MINICONDA_OSX="MacOSX-x86_64"
  matrix:
    # - PYTHON_VERSION=3.5
    # - PYTHON_VERSION=3.6
    - PYTHON_VERSION=3.7

addons:
  apt:
    packages:
      - build-essential
      - python3-dev
      - gfortran
      - libgsl0-dev
      - cmake
      - libfftw3-3
      - libfftw3-dev
      - libmpfr6
      - libmpfr-dev
      - libhdf5-serial-dev
      - hdf5-tools
      - libmpich-dev
      - mpich
      # - libopenmpi-dev
      # - openmpi-bin
  homebrew:
    packages:
      # - python
      # - gcc@8
      # - hdf5
      # - netcdf
      # - cmake


before_install:
  # - if [[ $TRAVIS_OS_NAME == linux ]]; then ; fi
  - if [[ $TRAVIS_OS_NAME == osx ]]; then
      export MINICONDA_OS=$MINICONDA_OSX
      wget "http://repo.continuum.io/miniconda/Miniconda$MINICONDA_PYTHON_MAJOR-$MINICONDA_VERSION-$MINICONDA_OS.sh" -O miniconda.sh;
      bash miniconda.sh -b -p $HOME/miniconda
      export CONDA_PREFIX=$HOME/miniconda
      export PATH="$CONDA_PREFIX/bin:$PATH"
      hash -r
      conda update -yq conda
      # gather the conda packages to install in one go, saving time
      export CONDA_OPTIONS="-c conda-forge -c anaconda"  # N.B.: order matters, first is search first!
      export CONDA_PACKAGES="gfortran_osx-64"  # configure wants this, even just for the framework target
      export CONDA_PACKAGES="${CONDA_PACKAGES} mpi4py nose numpy docutils h5py"  # additional basic dependencies
      export CONDA_PACKAGES="${CONDA_PACKAGES} openmpi cython"  # for the compile_tests
      #- export CONDA_PACKAGES="${CONDA_PACKAGES} -c conda-forge fftw mpfr gsl gmp pkg-config"  # for a full build including community codes
      conda install -y ${CONDA_OPTIONS} ${CONDA_PACKAGES}
    fi
  # - pip install --upgrade pip
  - pip install numpy scipy matplotlib pytest docutils mpi4py h5py Cython
  - pip install pytest-cov codecov pytest-timeout

install:
  - if [[ $TRAVIS_OS_NAME == osx ]]; then
    env CXX=clang++ CC=clang LDFLAGS="-Wl,-rpath,$CONDA_PREFIX/lib" ./configure --with-hdf5=$CONDA_PREFIX --with-gmp=$CONDA_PREFIX --with-mpfr=$CONDA_PREFIX --with-fftw=$CONDA_PREFIX --with-gsl-prefix=$CONDA_PREFIX
    fi
  - pip install -e .
  - ./configure
  - make framework

virtualenv:
  system_site_packages: false

script:
  - mpiexec -n 1 py.test --timeout=10 --cov-report=xml --cov=amuse --pyargs amuse.test.suite.reports.test_speed
  - mpiexec -n 1 py.test --timeout=30 --cov-report=xml --cov=amuse --pyargs amuse.test.suite.core_tests
  - mpiexec -n 1 py.test --timeout=10 --cov-report=xml --cov=amuse --pyargs amuse.test.suite.compile_tests
  
after_success:
  - codecov
