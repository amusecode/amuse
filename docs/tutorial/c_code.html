

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Integrate a C++ code &mdash; AMUSE 12.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/graphviz.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Integrate a Fortran 90 code" href="fortran_code.html" />
    <link rel="prev" title="Working with Particle Sets" href="particle_sets.html" />
     
    <link rel="stylesheet" href="../_static/default.css" type="text/css">

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> AMUSE
          

          
          </a>

          
            
            
              <div class="version">
                12.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../install/index.html">Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="units.html">Working with Units</a></li>
<li class="toctree-l2"><a class="reference internal" href="units.html#quantities">Quantities</a></li>
<li class="toctree-l2"><a class="reference internal" href="units.html#working-with-arrays">Working with arrays</a></li>
<li class="toctree-l2"><a class="reference internal" href="most_massive_from_salpeter.html">Estimating the typical mass of the most massive star in a cluster</a></li>
<li class="toctree-l2"><a class="reference internal" href="particle_sets.html">Working with Particle Sets</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Integrate a C++ code</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#two-paths">Two paths</a></li>
<li class="toctree-l3"><a class="reference internal" href="#procedure">Procedure</a></li>
<li class="toctree-l3"><a class="reference internal" href="#before-we-start">Before we start</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#environment-variables">Environment variables</a></li>
<li class="toctree-l4"><a class="reference internal" href="#the-name-of-our-project">The name of our project</a></li>
<li class="toctree-l4"><a class="reference internal" href="#creating-the-initial-directory-structure">Creating the initial directory structure</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#the-legacy-code">The Legacy Code</a></li>
<li class="toctree-l3"><a class="reference internal" href="#path-1">Path 1</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#defining-the-legacy-interface">Defining the legacy interface</a></li>
<li class="toctree-l4"><a class="reference internal" href="#defining-the-object-oriented-interface">Defining the Object Oriented Interface</a></li>
<li class="toctree-l4"><a class="reference internal" href="#configuring-the-handlers">Configuring the handlers</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#path-2">Path 2</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id1">Defining the legacy interface</a></li>
<li class="toctree-l3"><a class="reference internal" href="#filling-the-stubs">Filling the stubs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#defining-methods">Defining methods</a></li>
<li class="toctree-l3"><a class="reference internal" href="#defining-a-set">Defining a set</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="fortran_code.html">Integrate a Fortran 90 code</a></li>
<li class="toctree-l2"><a class="reference internal" href="gravitational_dynamics_code.html">Adding a Gravitational Dynamics Code</a></li>
<li class="toctree-l2"><a class="reference internal" href="legacy_code.html">Create an low-level Interface to a Code</a></li>
<li class="toctree-l2"><a class="reference internal" href="blender.html">Using Blender for visualising Amuse results</a></li>
<li class="toctree-l2"><a class="reference internal" href="plot.html">Plotting with amuse</a></li>
<li class="toctree-l2"><a class="reference internal" href="grid_boundary.html">Setting values for grid boundaries</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../interactive_tutorial/index.html">Interactive tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/index.html">Reference documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design/index.html">Design documentation</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">AMUSE</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Tutorials</a> &raquo;</li>
        
      <li>Integrate a C++ code</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/tutorial/c_code.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="integrate-a-c-code">
<h1>Integrate a C++ code<a class="headerlink" href="#integrate-a-c-code" title="Permalink to this headline">¶</a></h1>
<p>In this tutorial we will create an AMUSE interface to a C++
code. We will first define the legacy interface, then implement the
code and finally build an object oriented interface on top of the
legacy interface.</p>
<p>The legacy code will be a very simple and naive implementation to find
3 nearest neighbors of a particle.</p>
<p>The legacy code interface supports methods that transfer values to
and from the code. The values do not have any units and no error
handling is provided by the interface. We can add error handling, unit
handling and more functions to the legacy interface by defining a
subclass of a InCodeComponentImplementation (this is the objected oriented interface).</p>
<div class="graphviz"><img src="../_images/graphviz-d779ec1b692c600af6209b5756a4fa81b55ab6a0.png" alt="digraph layers4 {
   fontsize=10.0;
     rankdir=&quot;LR&quot;;
     node [fontsize=10.0, shape=box, style=filled, fillcolor=lightyellow];

     &quot;Legacy Code&quot; -&gt; &quot;Legacy Interface&quot; -&gt; &quot;Object Oriented Interface&quot; -&gt; &quot;Script&quot;;
 }" class="graphviz" /></div>
<p>The legacy code in this tutorial will be a very simple and naive
implementation to find 3 nearest neighbors of a particle.</p>
<div class="section" id="two-paths">
<h2>Two paths<a class="headerlink" href="#two-paths" title="Permalink to this headline">¶</a></h2>
<p>When defining the interface will walk 2 paths:</p>
<ol class="arabic simple">
<li>Management of particles in AMUSE (python)</li>
<li>Management of particles in the code (C or Fortran)</li>
</ol>
<p>The first path makes sense for legacy codes that perform a
transformation on the particles, or analyse the particles state or
do not store any internal state between function calls (all data is
external). For every function of the code, data of every particle is
send to the code. If we expect multiple calls, the code would incur a
high communication overhead and we are better of choosing path 2.</p>
<p>The second path makes sense for codes that already have management
of a particles (or grid) or were we want to call multiple functions
of the code and need to send the complete model to code for every
function call. The code is first given the data, then calls are made
to the code to evolve it’s model or perform reduction steps on the
data, finally the updated data is retrieved from the code.</p>
</div>
<div class="section" id="procedure">
<h2>Procedure<a class="headerlink" href="#procedure" title="Permalink to this headline">¶</a></h2>
<p>The suggested procedure for creating a new interface is as follows:</p>
<ol class="arabic simple" start="0">
<li><strong>Legacy Interface.</strong> Start with creating the legacy
interface. Define functions on the interface to input and
output relevant data.
The InCodeComponentImplementation code depends on the legacy interface code.</li>
<li><strong>Make a Class.</strong> Create a subclass of the InCodeComponentImplementation class</li>
<li><strong>Define methods.</strong> In the legacy interface we have defined functions
with parameters. In the code interface we need to define the
units of the parameters and if a parameter or return value
is used as an errorcode.</li>
<li><strong>Define properties.</strong> Some functions in the legacy interface can
be better described as a property of the code. These are read only
variables, like the current model time.</li>
<li><strong>Define parameters.</strong> Some functions in the legacy interface provide
access to parameters of the code. Units and default values
need to be defined for the parameters in this step</li>
<li><strong>Define sets or grids.</strong> A code usually handles objects or gridpoints with
attributes. In this step a generic interface is defined for these
objects so that the interoperability between codes increases.</li>
</ol>
</div>
<div class="section" id="before-we-start">
<h2>Before we start<a class="headerlink" href="#before-we-start" title="Permalink to this headline">¶</a></h2>
<p>This tutorial assumes you have a working amuse environment. Please
ensure that amuse is setup correctly by running ‘nosetests’ in the
amuse directory.</p>
<div class="section" id="environment-variables">
<h3>Environment variables<a class="headerlink" href="#environment-variables" title="Permalink to this headline">¶</a></h3>
<p>To simplify the work in the coming sections, we first define the
environment variable ‘AMUSE_DIR’. This environment variable must
point to the root directory of AMUSE (this is the directory
containing the build.py script).</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&gt; <span class="nb">export</span> <span class="nv">AMUSE_DIR</span><span class="o">=</span>&lt;path to the amuse root directory&gt;
</pre></div>
</div>
<p>or in a c shell:</p>
<div class="highlight-csh notranslate"><div class="highlight"><pre><span></span>&gt; <span class="nb">setenv </span>AMUSE_DIR &lt;path to the amuse root directory&gt;
</pre></div>
</div>
<p>After building the code, we want to run and test the code. Check if
amuse is available in your python path by running the following code
on the command line.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&gt; python -c <span class="s2">&quot;import amuse&quot;</span>
Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
File <span class="s2">&quot;&lt;string&gt;&quot;</span>, line <span class="m">1</span>, in &lt;module&gt;
ImportError: No module named amuse
</pre></div>
</div>
<p>If this code ends in a “ImportError” as shown in the example, the
PYTHONPATH environment variable must be extended with the src directory
in AMUSE_DIR.
We can do so by using one of the following commands.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&gt; <span class="nb">export</span> <span class="nv">PYTHONPATH</span><span class="o">=</span><span class="si">${</span><span class="nv">PYTHONPATH</span><span class="si">}</span>:<span class="si">${</span><span class="nv">AMUSE_DIR</span><span class="si">}</span>/src
</pre></div>
</div>
<p>or in a c shell:</p>
<div class="highlight-csh notranslate"><div class="highlight"><pre><span></span>&gt; <span class="nb">setenv </span>AMUSE_DIR <span class="k">${</span><span class="nv">PYTHONPATH</span><span class="k">}</span>:<span class="k">${</span><span class="nv">AMUSE_DIR</span><span class="k">}</span>/src
</pre></div>
</div>
</div>
<div class="section" id="the-name-of-our-project">
<h3>The name of our project<a class="headerlink" href="#the-name-of-our-project" title="Permalink to this headline">¶</a></h3>
<p>We will be writing a code to find the nearest neighbors of a particle,
so let’s call our project ‘NearestNeighbor’.</p>
</div>
<div class="section" id="creating-the-initial-directory-structure">
<h3>Creating the initial directory structure<a class="headerlink" href="#creating-the-initial-directory-structure" title="Permalink to this headline">¶</a></h3>
<p>First we need to create a directory for our project and put some
files in it to help build the code. The fastest method to setup the
directory is by using the build.py script.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&gt; <span class="nv">$AMUSE_DIR</span>/build.py --type<span class="o">=</span>c --mode<span class="o">=</span>dir NearestNeighbor
</pre></div>
</div>
<p>The script will generate a directory with all the files needed to
start our project. It also generates a very small example legacy code
with only one function <code class="docutils literal notranslate"><span class="pre">`echo_int`</span></code>. We can build and test our new
module:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&gt; cd nearestneighbor/
&gt; make all
&gt; $AMUSE_DIR/amuse.sh -c &#39;from interface import NearestNeighbor; print NearestNeighbor().echo_int(10)&#39;
OrderedDictionary({&#39;int_out&#39;:10, &#39;__result&#39;:0})
&gt; nosetests -v
.
----------------------------------------------------------------------
Ran 1 test in 0.556s

OK
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>The build.py script can be used to generate a range of files. To
see what this file can do you can run the script with a <code class="docutils literal notranslate"><span class="pre">`--help`</span></code>
parameter, like so:</p>
<div class="last highlight-default notranslate"><div class="highlight"><pre><span></span>&gt; $AMUSE_DIR/build.py --help
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="the-legacy-code">
<h2>The Legacy Code<a class="headerlink" href="#the-legacy-code" title="Permalink to this headline">¶</a></h2>
<p>Normally the legacy code already exists and our task is limited to
defining and implementing an interface so that AMUSE scripts can
access the code. For this tutorial we will implement our legacy code.</p>
<p>When a legacy code is integrated all interface code is put in one
directory and all the legacy code is put in a <strong>src</strong> directory
placed under this directory. The build.py script created a <strong>src</strong>
directory for us, and we will put the nearest neighbor algorithm in
this directory.</p>
<p>Go to the <strong>src</strong> directory and create a <strong>code.cc</strong> file, open
this file in your favorite editor and copy and paste this code into
it:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&quot;code.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;math.h&gt;</span><span class="cp"></span>

<span class="cm">/**</span>
<span class="cm"> * return the distance between point0 and point1</span>
<span class="cm"> */</span>
<span class="kt">double</span> <span class="nf">distance_between_points</span><span class="p">(</span>
    <span class="kt">double</span> <span class="n">x0</span><span class="p">,</span> <span class="kt">double</span> <span class="n">y0</span><span class="p">,</span> <span class="kt">double</span> <span class="n">z0</span><span class="p">,</span> 
    <span class="kt">double</span> <span class="n">x1</span><span class="p">,</span> <span class="kt">double</span> <span class="n">y1</span><span class="p">,</span> <span class="kt">double</span> <span class="n">z1</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">double</span> <span class="n">dx</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">-</span> <span class="n">x0</span><span class="p">;</span>
    <span class="kt">double</span> <span class="n">dy</span> <span class="o">=</span> <span class="n">y1</span> <span class="o">-</span> <span class="n">y0</span><span class="p">;</span>
    <span class="kt">double</span> <span class="n">dz</span> <span class="o">=</span> <span class="n">z1</span> <span class="o">-</span> <span class="n">z0</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">dx</span> <span class="o">*</span> <span class="n">dx</span>  <span class="o">+</span> <span class="n">dy</span> <span class="o">*</span> <span class="n">dy</span> <span class="o">+</span> <span class="n">dz</span> <span class="o">*</span> <span class="n">dz</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">DistanceAndIndex</span><span class="p">{</span>
    
<span class="k">public</span><span class="o">:</span>
    <span class="kt">double</span> <span class="n">r</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
    
    <span class="n">DistanceAndIndex</span><span class="p">()</span><span class="o">:</span><span class="n">r</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="n">index</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{}</span>
    <span class="n">DistanceAndIndex</span><span class="p">(</span><span class="n">DistanceAndIndex</span> <span class="o">&amp;</span> <span class="n">original</span><span class="p">)</span><span class="o">:</span><span class="n">r</span><span class="p">(</span><span class="n">original</span><span class="p">.</span><span class="n">r</span><span class="p">),</span><span class="n">index</span><span class="p">(</span><span class="n">original</span><span class="p">.</span><span class="n">index</span><span class="p">){}</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * Find the nearest neigbors of all the points (specified with</span>
<span class="cm"> * x, y and z).</span>
<span class="cm"> * </span>
<span class="cm"> * Fills the n1, n2 and n3 arrays with the closest, second clostest</span>
<span class="cm"> * and third closests points.</span>
<span class="cm"> * </span>
<span class="cm"> **/</span>
<span class="kt">int</span> <span class="nf">find_nearest_neighbors</span><span class="p">(</span><span class="kt">int</span> <span class="n">npoints</span><span class="p">,</span> 
    <span class="kt">double</span> <span class="o">*</span> <span class="n">x</span><span class="p">,</span> <span class="kt">double</span> <span class="o">*</span> <span class="n">y</span><span class="p">,</span> <span class="kt">double</span> <span class="o">*</span> <span class="n">z</span><span class="p">,</span>
    <span class="kt">int</span> <span class="o">*</span> <span class="n">n0</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span> <span class="n">n1</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span> <span class="n">n2</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">npoints</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">DistanceAndIndex</span> <span class="n">found</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
        
        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">npoints</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>
            
            <span class="kt">double</span> <span class="n">x0</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
            <span class="kt">double</span> <span class="n">y0</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
            <span class="kt">double</span> <span class="n">z0</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
            
            <span class="kt">double</span> <span class="n">x1</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
            <span class="kt">double</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
            <span class="kt">double</span> <span class="n">z1</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
            
            <span class="kt">double</span> <span class="n">r</span> <span class="o">=</span> <span class="n">distance_between_points</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="p">,</span> <span class="n">z1</span><span class="p">);</span>
            
            <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span><span class="p">(</span><span class="n">found</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">index</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">found</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
                    <span class="n">found</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="n">found</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">l</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span><span class="n">l</span> <span class="o">&gt;</span> <span class="n">k</span><span class="p">;</span> <span class="n">l</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
                            <span class="n">found</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">found</span><span class="p">[</span><span class="n">l</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
                        <span class="p">}</span>
                        <span class="n">found</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
                        <span class="n">found</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
            
        <span class="p">}</span>
        
        <span class="n">n0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">found</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">index</span><span class="p">;</span>
        <span class="n">n1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">found</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">index</span><span class="p">;</span>
        <span class="n">n2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">found</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">index</span><span class="p">;</span>
    <span class="p">}</span>
    
    
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This algorithm is un-optimized and has N*N order. It is not meant
as very efficient code but as a readable example.</p>
</div>
<p>Before we can continue we also need to alter the <strong>Makefile</strong> in the
<strong>src</strong> directory, so that our <strong>code.cc</strong> file is included in the
build. To do so, open an editor on the Makefile and change the line:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CODEOBJS</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">o</span>
</pre></div>
</div>
<p>to:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CODEOBJS</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">o</span> <span class="n">code</span><span class="o">.</span><span class="n">o</span>
</pre></div>
</div>
<p>Test if the code builds. As we have not coupled our algorithm to the
interface we (we have not even defined an interface) we do not have
any new functionality. In the legacy interface directory (not the
<strong>src</strong> directory) do:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&gt; make all
&gt; nosetests
.
----------------------------------------------------------------------
Ran <span class="m">1</span> <span class="nb">test</span> in <span class="m">0</span>.427s

OK
</pre></div>
</div>
<p>It works, if the test fails for any reason please check that the C++
code is correct and that <code class="docutils literal notranslate"><span class="pre">worker_code</span></code> exists in your directory.</p>
</div>
<div class="section" id="path-1">
<h2>Path 1<a class="headerlink" href="#path-1" title="Permalink to this headline">¶</a></h2>
<div class="section" id="defining-the-legacy-interface">
<h3>Defining the legacy interface<a class="headerlink" href="#defining-the-legacy-interface" title="Permalink to this headline">¶</a></h3>
<p>We will first define a legacy interface so that we can call the
<strong>find_nearest_neighbors</strong> function from python. AMUSE can interact
with 2 classes of functions:</p>
<ol class="arabic">
<li><p class="first">A function with all scalar input and output variables. All variables
are simple, non-composite variables (like int or double).
For example:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">example1</span><span class="p">(</span><span class="kt">double</span> <span class="n">input</span><span class="p">,</span> <span class="kt">double</span> <span class="o">*</span><span class="n">output</span><span class="p">)</span>
<span class="p">{</span>
    <span class="o">*</span><span class="n">output</span> <span class="o">=</span> <span class="n">input</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p class="first">A function with all vector (or list) input and output variables and
a length variable. The return value is a scalar value.
For example:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">example2</span><span class="p">(</span><span class="kt">double</span> <span class="o">*</span><span class="n">input</span><span class="p">,</span> <span class="kt">double</span> <span class="o">*</span><span class="n">output</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">input</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
</ol>
<p>If you have functions that don’t follow this pattern you need to
define a convert function in C++ that provides an interface
following one of the two patterns supported by AMUSE.</p>
<p>In our case the <strong>find_nearest_neighbors</strong> complies to pattern 2 and
we do not have to write any code in C++ to convert the function
to a compliant interface. We only have to specify the function in
python. We do so by adding a <strong>find_nearest_neighbors</strong> method to
the <strong>NearestNeighborInterface</strong> class in the <strong>interface.py</strong> file.
Open and editor on the interfaces.py file and add the following method
to the NearestNeighborInterface class:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">NearestNeighborInterface</span><span class="p">(</span><span class="n">InCodeComponentImplementation</span><span class="p">):</span>
    <span class="c1">#...</span>

    <span class="nd">@legacy_function</span>
    <span class="k">def</span> <span class="nf">find_nearest_neighbors</span><span class="p">():</span>
        <span class="n">function</span> <span class="o">=</span> <span class="n">LegacyFunctionSpecification</span><span class="p">()</span>
        <span class="n">function</span><span class="o">.</span><span class="n">must_handle_array</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">function</span><span class="o">.</span><span class="n">addParameter</span><span class="p">(</span>
            <span class="s1">&#39;npoints&#39;</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">,</span>
            <span class="n">direction</span><span class="o">=</span><span class="n">function</span><span class="o">.</span><span class="n">LENGTH</span><span class="p">)</span>
        <span class="n">function</span><span class="o">.</span><span class="n">addParameter</span><span class="p">(</span>
            <span class="s1">&#39;x&#39;</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">,</span>
            <span class="n">direction</span><span class="o">=</span><span class="n">function</span><span class="o">.</span><span class="n">IN</span><span class="p">)</span>
        <span class="n">function</span><span class="o">.</span><span class="n">addParameter</span><span class="p">(</span>
            <span class="s1">&#39;y&#39;</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">,</span>
            <span class="n">direction</span><span class="o">=</span><span class="n">function</span><span class="o">.</span><span class="n">IN</span><span class="p">)</span>
        <span class="n">function</span><span class="o">.</span><span class="n">addParameter</span><span class="p">(</span>
            <span class="s1">&#39;z&#39;</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">,</span>
            <span class="n">direction</span><span class="o">=</span><span class="n">function</span><span class="o">.</span><span class="n">IN</span><span class="p">)</span>
        <span class="n">function</span><span class="o">.</span><span class="n">addParameter</span><span class="p">(</span>
            <span class="s1">&#39;n0&#39;</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">,</span>
            <span class="n">direction</span><span class="o">=</span><span class="n">function</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>
        <span class="n">function</span><span class="o">.</span><span class="n">addParameter</span><span class="p">(</span>\
            <span class="s1">&#39;n1&#39;</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">,</span>
            <span class="n">direction</span><span class="o">=</span><span class="n">function</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>
        <span class="n">function</span><span class="o">.</span><span class="n">addParameter</span><span class="p">(</span>
            <span class="s1">&#39;n2&#39;</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">,</span>
            <span class="n">direction</span><span class="o">=</span><span class="n">function</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>
        <span class="n">function</span><span class="o">.</span><span class="n">result_type</span> <span class="o">=</span> <span class="s1">&#39;int32&#39;</span>
        <span class="k">return</span> <span class="n">function</span>
</pre></div>
</div>
<p>In the <em>find_nearest_neighbors</em> method we specify every parameter of
the C++ function and the result type. For each parameter we need
to define a name, data type and whether we will input, output (or
input and output) data using this parameter. AMUSE knows only a
limited amount of data types for parameters: float64, float32, int32, string, bool and int64. We also have a special parameter, with LENGTH as
direction. This parameter is needed for all functions that follow
pattern 2, it will be filled with the length of the input arrays. We
also must specify that the function follows pattern 2 by setting
<code class="docutils literal notranslate"><span class="pre">`function.must_handle_array</span> <span class="pre">=</span> <span class="pre">True`</span></code>.</p>
<p>Save the file and recompile the code.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&gt; make clean
&gt; make all
&gt; nosetests
.
----------------------------------------------------------------------
Ran <span class="m">1</span> <span class="nb">test</span> in <span class="m">0</span>.427s

OK
</pre></div>
</div>
<p>It works! But, how do we know the find_nearest_neighbors method really works?
Let’s write a test and find out. Open an editor on the <em>test_nearestneighbor.py</em>
file and add the following method to the <strong>NearestNeighborInterfaceTests</strong> class:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">instance</span> <span class="o">=</span> <span class="n">NearestNeighborInterface</span><span class="p">()</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">z</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="n">n0</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">find_nearest_neighbors</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">error</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">n0</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">n2</span><span class="p">,</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">instance</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</pre></div>
</div>
<p>This test calls the <em>find_nearest_neighbors</em> method with 4 positions
and checks if the nearest neighbors are determined correctly.
Let’s run the test, and see if everything is working:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&gt; nosetests
..
----------------------------------------------------------------------
Ran <span class="m">2</span> <span class="nb">test</span> in <span class="m">0</span>.491s

OK
</pre></div>
</div>
<p>We now have a simple interface that works, but we have to do our own
indexing after the call and we could send data of any unit to the
method, also we have to do our own error checking after the method. Let’s
define a object oriented interface to solve these problems</p>
</div>
<div class="section" id="defining-the-object-oriented-interface">
<h3>Defining the Object Oriented Interface<a class="headerlink" href="#defining-the-object-oriented-interface" title="Permalink to this headline">¶</a></h3>
<p>The object oriented interface sits on top of the legacy interface.
It decorates this interface with sets, unit handling, state engine
and more. We start creating the object oriented interface by inheriting
from InCodeComponentImplementation and writing the __init__ function. The build script
has added this class to the interface.py file for us. Open an editor
on interface.py and make sure this code is in the file (at the end
of the file):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">NearestNeighbor</span><span class="p">(</span><span class="n">InCodeComponentImplementation</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="n">InCodeComponentImplementation</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">NearestNeighborInterface</span><span class="p">(),</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="configuring-the-handlers">
<h3>Configuring the handlers<a class="headerlink" href="#configuring-the-handlers" title="Permalink to this headline">¶</a></h3>
<p>We configure the object oriented interface by implementing several
methods. The object oriented interface is implement by several
“handlers”. Each handler provides support for a specific aspect of
the interface. AMUSE defines a handler for the unit conversion, a
handler for the interfacing with sets of particles, a handler to
ensure the methods are called in the right order, etc. Each handler
is very generic and needs to be configured before use. The handler
are configured using the “Visitor” pattern. The following
pseudo-code shows how the handlers are configured</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">InCodeComponentImplementation</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="c1">#...</span>

    <span class="k">def</span> <span class="nf">configure_handlers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#...</span>
        <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_handlers</span><span class="p">():</span>
            <span class="n">handler</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">define_converter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; configure the units converter handler &quot;&quot;&quot;</span>

        <span class="n">handler</span><span class="o">.</span><span class="n">set_nbody_converter</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">define_particle_sets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; configure sets of particles &quot;&quot;&quot;</span>

        <span class="n">handler</span><span class="o">.</span><span class="n">define_incode_particle_set</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">set_getter</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">HandleConvertUnits</span><span class="p">(</span><span class="n">AbstractHandler</span><span class="p">):</span>
    <span class="c1">#...</span>

    <span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interface</span><span class="p">):</span>
        <span class="n">interface</span><span class="o">.</span><span class="n">define_converter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">HandleParticles</span><span class="p">(</span><span class="n">AbstractHandler</span><span class="p">):</span>
    <span class="c1">#...</span>

    <span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interface</span><span class="p">):</span>
        <span class="n">interface</span><span class="o">.</span><span class="n">define_particle_sets</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</pre></div>
</div>
<p>Configuration of the handlers is optional, we only have to define
those handler that we need in our interface. In our example we need
to configure the “HandleMethodsWithUnits” handler (to define units and
error handling) and the “HandleParticles” to define a particle set.</p>
<div class="section" id="defining-methods-with-units">
<h4>Defining methods with units<a class="headerlink" href="#defining-methods-with-units" title="Permalink to this headline">¶</a></h4>
<p>We first want to add units and error handling to the
<strong>find_nearest_neighbors</strong>. We do this by creating a
<strong>define_methods</strong> function on the <strong>NearestNeighbor</strong> class. Open
an editor on <em>interface.py</em> and add this method to the class:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">define_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">):</span>

    <span class="n">handler</span><span class="o">.</span><span class="n">add_method</span><span class="p">(</span>
        <span class="s2">&quot;find_nearest_neighbors&quot;</span><span class="p">,</span>
        <span class="p">(</span>
            <span class="n">generic_unit_system</span><span class="o">.</span><span class="n">length</span><span class="p">,</span>
            <span class="n">generic_unit_system</span><span class="o">.</span><span class="n">length</span><span class="p">,</span>
            <span class="n">generic_unit_system</span><span class="o">.</span><span class="n">length</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="p">(</span>
            <span class="n">handler</span><span class="o">.</span><span class="n">INDEX</span><span class="p">,</span>
            <span class="n">handler</span><span class="o">.</span><span class="n">INDEX</span><span class="p">,</span>
            <span class="n">handler</span><span class="o">.</span><span class="n">INDEX</span><span class="p">,</span>
            <span class="n">handler</span><span class="o">.</span><span class="n">ERROR_CODE</span>
        <span class="p">)</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>The <strong>add_method</strong> call expects the name of the function in the
legacy interface as it’s first, next it expects a list of the units
of the input parameters and a list of the units of the output parameters.
The return value of a function is always the last item in the list
of output parameters. We specify a <strong>generic_unit_system.length</strong> unit
for the x, y and z parameters. The output parameters are indices and
an errorcode. The errorcode will be handled by the AMUSE interface (0
means success and &lt; 0 means raise an exception).</p>
<p>Let’s write a test to see if it works, open an editor on the
test_nearestneighbor.py class and add this method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test3</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">instance</span> <span class="o">=</span> <span class="n">NearestNeighbor</span><span class="p">()</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">]</span> <span class="o">|</span> <span class="n">generic_unit_system</span><span class="o">.</span><span class="n">length</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">|</span> <span class="n">generic_unit_system</span><span class="o">.</span><span class="n">length</span>
    <span class="n">z</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">|</span> <span class="n">generic_unit_system</span><span class="o">.</span><span class="n">length</span>

    <span class="n">n0</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">find_nearest_neighbors</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">n0</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">n2</span><span class="p">,</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">instance</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This test looks a lot like test2, but we now have to
define a unit and we do not need to handle the errorcode.</p>
</div>
<p>Now build and test the code:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&gt; make clean<span class="p">;</span> make all
&gt; nosetests
...
----------------------------------------------------------------------
Ran <span class="m">3</span> tests in <span class="m">0</span>.650s

OK
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Although we only edited python code we still need to run make. The
code will check if the “worker_code” executable is up to date on
every run. It cannot detect if the update broke the code but it
will still demand that the code is rebuilt.</p>
</div>
</div>
<div class="section" id="defining-the-particle-set">
<h4>Defining the particle set<a class="headerlink" href="#defining-the-particle-set" title="Permalink to this headline">¶</a></h4>
<p>Particle sets in AMUSE can be handled by python (we call these
“inmemory”) and by the legacy code (we call these “incode”). In our
case the code does not handle the particles and we need to
configure the particles handler to manage an inmemory particle set.
Open an editor on <em>interface.py</em> and add this method to the
<strong>NearestNeighbor</strong> class:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">define_particle_sets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">object</span><span class="p">):</span>
    <span class="nb">object</span><span class="o">.</span><span class="n">define_inmemory_set</span><span class="p">(</span><span class="s1">&#39;particles&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>That’s all we now have a “particles” attribute on the class and
we can add, remove, delete particles from this set. But we are
still missing a connection between the particles and the nearest
neighbors. AMUSE provides no handler for this, instead, we
will write a method to run the find_nearest_neighbors function and
set the indices on the particles set.</p>
<p>Open an editor on <em>interface.py</em> and add this method to the
<strong>NearestNeighbor</strong> class:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">indices0</span><span class="p">,</span> <span class="n">indices1</span><span class="p">,</span> <span class="n">indices2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_nearest_neighbors</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="o">.</span><span class="n">z</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="o">.</span><span class="n">neighbor0</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="p">[</span><span class="n">indices0</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="o">.</span><span class="n">neighbor1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="p">[</span><span class="n">indices1</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="o">.</span><span class="n">neighbor2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="p">[</span><span class="n">indices2</span><span class="p">])</span>
</pre></div>
</div>
<p>This function gets the “x”, “y” and “z” attributes from the particles
set and sends these to the “find_nearest_neighbors” method. This methods
returns 3 lists of indices and we need to find the particles with
these indices.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Particle sets have no given sequence, deletion and addition of
particles will change the order of the particles in the set. It
is therefor never a good idea to use the index of the particle in the
set as a reference to that particle. However, in the “run” method
we “own” the particle set, it cannot change between the find_nearest_neighbor
call and the moment we find the particles in the set by index (using
self.particles[indices0]), and in this case it is save to use
index as a valid reference.</p>
</div>
<p>Let’s write a test and see if it works, open an editor on the
test_nearestneighbor.py class and add this method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test4</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">instance</span> <span class="o">=</span> <span class="n">NearestNeighbor</span><span class="p">()</span>

    <span class="n">particles</span> <span class="o">=</span> <span class="n">datamodel</span><span class="o">.</span><span class="n">Particles</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">particles</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">]</span> <span class="o">|</span> <span class="n">generic_unit_system</span><span class="o">.</span><span class="n">length</span>
    <span class="n">particles</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="o">|</span> <span class="n">generic_unit_system</span><span class="o">.</span><span class="n">length</span>
    <span class="n">particles</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="o">|</span> <span class="n">generic_unit_system</span><span class="o">.</span><span class="n">length</span>

    <span class="n">instance</span><span class="o">.</span><span class="n">particles</span><span class="o">.</span><span class="n">add_particles</span><span class="p">(</span><span class="n">particles</span><span class="p">)</span>
    <span class="n">instance</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">particles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">neighbor0</span><span class="p">,</span> <span class="n">instance</span><span class="o">.</span><span class="n">particles</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">particles</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">neighbor0</span><span class="p">,</span> <span class="n">instance</span><span class="o">.</span><span class="n">particles</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">particles</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">neighbor0</span><span class="p">,</span> <span class="n">instance</span><span class="o">.</span><span class="n">particles</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">particles</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">neighbor0</span><span class="p">,</span> <span class="n">instance</span><span class="o">.</span><span class="n">particles</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

    <span class="n">instance</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</pre></div>
</div>
<p>Now, make and run the tests:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&gt; make clean<span class="p">;</span> make all
&gt; nosetests
....
----------------------------------------------------------------------
Ran <span class="m">4</span> tests in <span class="m">0</span>.797s

OK
</pre></div>
</div>
<p>We are done, we have defined an object oriented interface on the
legacy interface. Only, if we look at our tests, the code seems
to be more rather than less complex. But, remember we now
have units and we are compatible with other parts of amuse. And
we can make more complex scripts easier.</p>
<p>Let’s make a plummer model and find the nearest neighbors in this model.</p>
<p>First make a file with the following contents, let’s call this file
<strong>plummer2.py</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">interface</span> <span class="kn">import</span> <span class="n">NearestNeighbor</span>
<span class="kn">from</span> <span class="nn">amuse.lab</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">amuse.io</span> <span class="kn">import</span> <span class="n">text</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">number_of_particles</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="n">particles</span> <span class="o">=</span> <span class="n">new_plummer_sphere</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>

    <span class="n">code</span> <span class="o">=</span> <span class="n">NearestNeighbor</span><span class="p">()</span>
    <span class="n">code</span><span class="o">.</span><span class="n">particles</span><span class="o">.</span><span class="n">add_particles</span><span class="p">(</span><span class="n">particles</span><span class="p">)</span>

    <span class="n">code</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="n">local_particles</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">particles</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="n">local_particles</span><span class="o">.</span><span class="n">neighbor1</span><span class="o">.</span><span class="n">as_set</span><span class="p">()</span><span class="o">.</span><span class="n">position</span> <span class="o">-</span> <span class="n">local_particles</span><span class="o">.</span><span class="n">position</span>
   
    <span class="n">local_particles</span><span class="o">.</span><span class="n">dx</span> <span class="o">=</span> <span class="n">delta</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">local_particles</span><span class="o">.</span><span class="n">dy</span> <span class="o">=</span> <span class="n">delta</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">local_particles</span><span class="o">.</span><span class="n">dz</span> <span class="o">=</span> <span class="n">delta</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">output</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">TableFormattedText</span><span class="p">(</span><span class="s2">&quot;output.txt&quot;</span><span class="p">,</span> <span class="nb">set</span> <span class="o">=</span> <span class="n">local_particles</span><span class="p">)</span>
    <span class="n">output</span><span class="o">.</span><span class="n">attribute_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="s1">&#39;dx&#39;</span><span class="p">,</span> <span class="s1">&#39;dy&#39;</span><span class="p">,</span><span class="s1">&#39;dz&#39;</span><span class="p">]</span>
    <span class="n">output</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

</pre></div>
</div>
<p>We can run this file with python:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">..</span> <span class="n">code</span><span class="o">-</span><span class="n">block</span><span class="p">::</span> <span class="n">bash</span>
</pre></div>
</div>
<blockquote>
<div>$AMUSE_DIR/amuse.sh plummer2.py</div></blockquote>
<p>It will create an <strong>output.txt</strong> file and we can show this file
with gnuplot.</p>
<div class="highlight-gnuplot notranslate"><div class="highlight"><pre><span></span>gnuplot&gt; splot &#39;output.txt&#39; using 1:2:3:4:5:6 with vectors nohead, &#39;output.txt&#39; using 1:2:3
gnuplot&gt; #we can zoom into the center
gnuplot&gt; set xr[-0.5:0.5]
gnuplot&gt; set yr[-0.5:0.5]
gnuplot&gt; set zr[-0.5:0.5]
gnuplot&gt; splot &#39;output.txt&#39; using 1:2:3:4:5:6 with vectors nohead, &#39;output.txt&#39; using 1:2:3
</pre></div>
</div>
<img alt="../_images/plummer1.png" src="../_images/plummer1.png" />
</div>
</div>
</div>
<div class="section" id="path-2">
<h2>Path 2<a class="headerlink" href="#path-2" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="id1">
<h2>Defining the legacy interface<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>We define our code interface so that a user can add, update and
delete particles, start the nearest neighbors finding
algorithm and retrieve the ids of the nearest neighbors.</p>
<p>To define the interface, open interface.py with your favorite
editor and replace the contents of this file with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">amuse.community</span> <span class="k">import</span> <span class="o">*</span>

<span class="k">class</span> <span class="nc">NearestNeighborInterface</span><span class="p">(</span><span class="n">CodeInterface</span><span class="p">):</span>
    
    <span class="n">include_headers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;worker_code.h&#39;</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">keyword_arguments</span><span class="p">):</span>
        <span class="n">CodeInterface</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_of_the_worker</span><span class="o">=</span><span class="s2">&quot;nearestneighbor_worker&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">keyword_arguments</span><span class="p">)</span>
    
    <span class="nd">@legacy_function</span>
    <span class="k">def</span> <span class="nf">new_particle</span><span class="p">():</span>
        <span class="n">function</span> <span class="o">=</span> <span class="n">LegacyFunctionSpecification</span><span class="p">()</span>
        <span class="n">function</span><span class="o">.</span><span class="n">can_handle_array</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">function</span><span class="o">.</span><span class="n">addParameter</span><span class="p">(</span><span class="s1">&#39;index_of_the_particle&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">function</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>
        <span class="n">function</span><span class="o">.</span><span class="n">addParameter</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">function</span><span class="o">.</span><span class="n">IN</span><span class="p">)</span>
        <span class="n">function</span><span class="o">.</span><span class="n">addParameter</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">function</span><span class="o">.</span><span class="n">IN</span><span class="p">)</span>
        <span class="n">function</span><span class="o">.</span><span class="n">addParameter</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">function</span><span class="o">.</span><span class="n">IN</span><span class="p">)</span>
        <span class="n">function</span><span class="o">.</span><span class="n">result_type</span> <span class="o">=</span> <span class="s1">&#39;int32&#39;</span>
        <span class="k">return</span> <span class="n">function</span>

    <span class="nd">@legacy_function</span>
    <span class="k">def</span> <span class="nf">delete_particle</span><span class="p">():</span>
        <span class="n">function</span> <span class="o">=</span> <span class="n">LegacyFunctionSpecification</span><span class="p">()</span>  
        <span class="n">function</span><span class="o">.</span><span class="n">addParameter</span><span class="p">(</span><span class="s1">&#39;index_of_the_particle&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">function</span><span class="o">.</span><span class="n">IN</span><span class="p">)</span>
        <span class="n">function</span><span class="o">.</span><span class="n">result_type</span> <span class="o">=</span> <span class="s1">&#39;int32&#39;</span>
        <span class="k">return</span> <span class="n">function</span>

    <span class="nd">@legacy_function</span>
    <span class="k">def</span> <span class="nf">get_state</span><span class="p">():</span>
        <span class="n">function</span> <span class="o">=</span> <span class="n">LegacyFunctionSpecification</span><span class="p">()</span>
        <span class="n">function</span><span class="o">.</span><span class="n">can_handle_array</span> <span class="o">=</span> <span class="kc">True</span> 
        <span class="n">function</span><span class="o">.</span><span class="n">addParameter</span><span class="p">(</span><span class="s1">&#39;index_of_the_particle&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">function</span><span class="o">.</span><span class="n">IN</span><span class="p">)</span>
        <span class="n">function</span><span class="o">.</span><span class="n">addParameter</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">function</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>
        <span class="n">function</span><span class="o">.</span><span class="n">addParameter</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">function</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>
        <span class="n">function</span><span class="o">.</span><span class="n">addParameter</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">function</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>
        <span class="n">function</span><span class="o">.</span><span class="n">result_type</span> <span class="o">=</span> <span class="s1">&#39;int32&#39;</span>
        <span class="k">return</span> <span class="n">function</span>
        
    <span class="nd">@legacy_function</span>
    <span class="k">def</span> <span class="nf">set_state</span><span class="p">():</span>
        <span class="n">function</span> <span class="o">=</span> <span class="n">LegacyFunctionSpecification</span><span class="p">()</span>  
        <span class="n">function</span><span class="o">.</span><span class="n">can_handle_array</span> <span class="o">=</span> <span class="kc">True</span> 
        <span class="n">function</span><span class="o">.</span><span class="n">addParameter</span><span class="p">(</span><span class="s1">&#39;index_of_the_particle&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">function</span><span class="o">.</span><span class="n">IN</span><span class="p">)</span>
        <span class="n">function</span><span class="o">.</span><span class="n">addParameter</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">function</span><span class="o">.</span><span class="n">IN</span><span class="p">)</span>
        <span class="n">function</span><span class="o">.</span><span class="n">addParameter</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">function</span><span class="o">.</span><span class="n">IN</span><span class="p">)</span>
        <span class="n">function</span><span class="o">.</span><span class="n">addParameter</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">function</span><span class="o">.</span><span class="n">IN</span><span class="p">)</span>
        <span class="n">function</span><span class="o">.</span><span class="n">result_type</span> <span class="o">=</span> <span class="s1">&#39;int32&#39;</span>
        <span class="k">return</span> <span class="n">function</span>    

    <span class="nd">@legacy_function</span>
    <span class="k">def</span> <span class="nf">find_nearest_neighbors</span><span class="p">():</span>
        <span class="n">function</span> <span class="o">=</span> <span class="n">LegacyFunctionSpecification</span><span class="p">()</span>
        <span class="n">function</span><span class="o">.</span><span class="n">result_type</span> <span class="o">=</span> <span class="s1">&#39;int32&#39;</span>
        <span class="k">return</span> <span class="n">function</span>    
    
    <span class="nd">@legacy_function</span>
    <span class="k">def</span> <span class="nf">get_close_neighbors</span><span class="p">():</span>
        <span class="n">function</span> <span class="o">=</span> <span class="n">LegacyFunctionSpecification</span><span class="p">()</span>  
        <span class="n">function</span><span class="o">.</span><span class="n">can_handle_array</span> <span class="o">=</span> <span class="kc">True</span> 
        <span class="n">function</span><span class="o">.</span><span class="n">addParameter</span><span class="p">(</span><span class="s1">&#39;index_of_the_particle&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">function</span><span class="o">.</span><span class="n">IN</span><span class="p">)</span>
        <span class="n">function</span><span class="o">.</span><span class="n">addParameter</span><span class="p">(</span><span class="s1">&#39;index_of_first_neighbor&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">function</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>
        <span class="n">function</span><span class="o">.</span><span class="n">addParameter</span><span class="p">(</span><span class="s1">&#39;index_of_second_neighbor&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">function</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>
        <span class="n">function</span><span class="o">.</span><span class="n">addParameter</span><span class="p">(</span><span class="s1">&#39;index_of_third_neighbor&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">function</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>
        <span class="n">function</span><span class="o">.</span><span class="n">result_type</span> <span class="o">=</span> <span class="s1">&#39;int32&#39;</span>
        <span class="k">return</span> <span class="n">function</span>    
    
    <span class="nd">@legacy_function</span>
    <span class="k">def</span> <span class="nf">get_nearest_neighbor</span><span class="p">():</span>
        <span class="n">function</span> <span class="o">=</span> <span class="n">LegacyFunctionSpecification</span><span class="p">()</span>  
        <span class="n">function</span><span class="o">.</span><span class="n">can_handle_array</span> <span class="o">=</span> <span class="kc">True</span> 
        <span class="n">function</span><span class="o">.</span><span class="n">addParameter</span><span class="p">(</span><span class="s1">&#39;index_of_the_particle&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">function</span><span class="o">.</span><span class="n">IN</span><span class="p">)</span>
        <span class="n">function</span><span class="o">.</span><span class="n">addParameter</span><span class="p">(</span><span class="s1">&#39;index_of_the_neighbor&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">function</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>
        <span class="n">function</span><span class="o">.</span><span class="n">addParameter</span><span class="p">(</span><span class="s1">&#39;distance&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">function</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>
        <span class="n">function</span><span class="o">.</span><span class="n">result_type</span> <span class="o">=</span> <span class="s1">&#39;int32&#39;</span>
        <span class="k">return</span> <span class="n">function</span>
        
    <span class="nd">@legacy_function</span>
    <span class="k">def</span> <span class="nf">get_number_of_particles</span><span class="p">():</span>
        <span class="n">function</span> <span class="o">=</span> <span class="n">LegacyFunctionSpecification</span><span class="p">()</span>  
        <span class="n">function</span><span class="o">.</span><span class="n">can_handle_array</span> <span class="o">=</span> <span class="kc">True</span> 
        <span class="n">function</span><span class="o">.</span><span class="n">addParameter</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">function</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>
        <span class="n">function</span><span class="o">.</span><span class="n">result_type</span> <span class="o">=</span> <span class="s1">&#39;int32&#39;</span>
        <span class="k">return</span> <span class="n">function</span>    
    
    
<span class="k">class</span> <span class="nc">NearestNeighbor</span><span class="p">(</span><span class="n">InCodeComponentImplementation</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">InCodeComponentImplementation</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">NearestNeighborInterface</span><span class="p">())</span>
    
</pre></div>
</div>
<p>We can generate a stub from the interface code with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&gt; $AMUSE_DIR/build.py --type=c --mode=stub interface.py NearestNeighborInterface -o interface.cc
</pre></div>
</div>
<p>The generated <strong>interface.cc</strong> replaces the original file generated in
the previous section.</p>
<p>The code builds, but does not have any functionality yet:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">make</span> <span class="n">clean</span>
<span class="o">&gt;</span> <span class="n">make</span> <span class="nb">all</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Compiling the interface code will result in a lot of warnings about
unused dummy arguments. These warnings can be safely ignored for now.</p>
</div>
<p>The tests are broken (the echo_int function has been removed):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&gt; nosetests
<span class="nv">E</span>
<span class="o">======================================================================</span>
ERROR: test1 <span class="o">(</span>nearestneighbor.test_nearestneighbor.NearestNeighborInterfaceTests<span class="o">)</span>
----------------------------------------------------------------------
Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
  File <span class="s2">&quot;../src/amuse/test/amusetest.py&quot;</span>, line <span class="m">146</span>, in run
    testMethod<span class="o">()</span>
  File <span class="s2">&quot;nearestneighbor/test_nearestneighbor.py&quot;</span>, line <span class="m">11</span>, in test1
    result,error <span class="o">=</span> instance.echo_int<span class="o">(</span><span class="m">12</span><span class="o">)</span>
AttributeError: <span class="s1">&#39;NearestNeighborInterface&#39;</span> object has no attribute <span class="s1">&#39;echo_int&#39;</span>

----------------------------------------------------------------------
Ran <span class="m">1</span> <span class="nb">test</span> in <span class="m">0</span>.315s

FAILED <span class="o">(</span><span class="nv">errors</span><span class="o">=</span><span class="m">1</span><span class="o">)</span>
</pre></div>
</div>
<p>Let’s create a working test by calling the new_particle method, open an editor
on the test_nearestneighbor.py file and replace the test1 method with:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">instance</span> <span class="o">=</span> <span class="n">NearestNeighborInterface</span><span class="p">()</span>
    <span class="n">result</span><span class="p">,</span><span class="n">error</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">new_particle</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">instance</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</pre></div>
</div>
<p>As this is python code we do not need to rebuild the code, instead
we can run the tests right after saving the code. Unfortunately, when
we run the test, it still fails.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&gt; nosetests
<span class="nv">F</span>
<span class="o">======================================================================</span>
FAIL: test1 <span class="o">(</span>nearestneighbor.test_nearestneighbor.NearestNeighborInterfaceTests<span class="o">)</span>
----------------------------------------------------------------------
Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
  File <span class="s2">&quot;/src/amuse/test/amusetest.py&quot;</span>, line <span class="m">146</span>, in run
    testMethod<span class="o">()</span>
  File <span class="s2">&quot;/nearestneighbor/test_nearestneighbor.py&quot;</span>, line <span class="m">13</span>, in test1
    self.assertEquals<span class="o">(</span>result, <span class="m">1</span><span class="o">)</span>
  File <span class="s2">&quot;/src/amuse/test/amusetest.py&quot;</span>, line <span class="m">62</span>, in failUnlessEqual
    self._raise_exceptions_if_any<span class="o">(</span>failures, first, second, <span class="s1">&#39;{0} != {1}&#39;</span>, msg<span class="o">)</span>
  File <span class="s2">&quot;/src/amuse/test/amusetest.py&quot;</span>, line <span class="m">49</span>, in _raise_exceptions_if_any
    raise self.failureException<span class="o">(</span>msg or err_fmt_string.format<span class="o">(</span>first, second, *args<span class="o">))</span>
AssertionError: <span class="m">0</span> !<span class="o">=</span> <span class="m">1</span>
-------------------- &gt;&gt; begin captured logging &lt;&lt; --------------------
legacy: INFO: start call <span class="s1">&#39;NearestNeighborInterface.new_particle&#39;</span>
legacy: INFO: end call <span class="s1">&#39;NearestNeighborInterface.new_particle&#39;</span>
--------------------- &gt;&gt; end captured logging &lt;&lt; ---------------------

----------------------------------------------------------------------
Ran <span class="m">1</span> <span class="nb">test</span> in <span class="m">0</span>.319s
</pre></div>
</div>
<p>When you look closely at the output of the test you see that the result from the
method is 0 and not the expected 1. We need to edit the c code to make this
test work. Open an editor on interface.cc and go to the <em>new_particle</em> function.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">new_particle</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span> <span class="n">index_of_the_particle</span><span class="p">,</span> <span class="kt">double</span> <span class="n">x</span><span class="p">,</span> <span class="kt">double</span> <span class="n">y</span><span class="p">,</span>
    <span class="kt">double</span> <span class="n">z</span><span class="p">)</span>
<span class="p">{</span>
    <span class="o">*</span><span class="n">index_of_the_particle</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In AMUSE all interface functions return an errorcode. Any other return
values must be passed through the arguments of the functions.</p>
</div>
<p>We need to rebuild the code, and after building run the tests.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&gt; make all
&gt; nosetests
.
----------------------------------------------------------------------
Ran <span class="m">1</span> <span class="nb">test</span> in <span class="m">0</span>.427s

OK
</pre></div>
</div>
<p>The are tests work again! Only, we do not have any real working legacy code.</p>
</div>
<div class="section" id="filling-the-stubs">
<h2>Filling the stubs<a class="headerlink" href="#filling-the-stubs" title="Permalink to this headline">¶</a></h2>
<p>The implementation of the algorithm does not match the interface
we defined and created. We need to write some glue code to
connect the code with the interface. To do so we fill in the
stubs generated earlier.</p>
<p>Open the <strong>interface.cc</strong> file in your favorite editor and
change its contents to:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&quot;worker_code.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;src/code.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;map&gt;</span><span class="cp"></span>

<span class="k">class</span> <span class="nc">Particle</span><span class="p">{</span>

<span class="k">public</span><span class="o">:</span>
    <span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
    <span class="kt">double</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">n0</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">;</span>
    
    <span class="n">Particle</span><span class="p">(</span><span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="kt">double</span> <span class="n">x</span><span class="p">,</span> <span class="kt">double</span> <span class="n">y</span><span class="p">,</span> <span class="kt">double</span> <span class="n">z</span><span class="p">)</span><span class="o">:</span><span class="n">index</span><span class="p">(</span><span class="n">index</span><span class="p">),</span> <span class="n">x</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">y</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">z</span><span class="p">(</span><span class="n">z</span><span class="p">),</span> <span class="n">n0</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">n1</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">n2</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">}</span>
    <span class="n">Particle</span><span class="p">(</span><span class="k">const</span> <span class="n">Particle</span> <span class="o">&amp;</span> <span class="n">original</span><span class="p">)</span><span class="o">:</span><span class="n">index</span><span class="p">(</span><span class="n">original</span><span class="p">.</span><span class="n">index</span><span class="p">),</span> <span class="n">x</span><span class="p">(</span><span class="n">original</span><span class="p">.</span><span class="n">x</span><span class="p">),</span> <span class="n">y</span><span class="p">(</span><span class="n">original</span><span class="p">.</span><span class="n">y</span><span class="p">),</span> <span class="n">z</span><span class="p">(</span><span class="n">original</span><span class="p">.</span><span class="n">z</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">Particle</span> <span class="o">*&gt;</span> <span class="n">ParticlesMap</span><span class="p">;</span>
<span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">Particle</span> <span class="o">*&gt;::</span><span class="n">iterator</span> <span class="n">ParticlesMapIterator</span><span class="p">;</span>

<span class="kt">int</span> <span class="n">highest_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">ParticlesMap</span> <span class="n">particlesMap</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">find_nearest_neighbors</span><span class="p">(){</span>
  <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">n</span> <span class="o">=</span> <span class="n">particlesMap</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
  
  <span class="kt">double</span> <span class="o">*</span> <span class="n">x</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">double</span><span class="p">[</span><span class="n">n</span><span class="p">];</span>
  <span class="kt">double</span> <span class="o">*</span> <span class="n">y</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">double</span><span class="p">[</span><span class="n">n</span><span class="p">];</span>
  <span class="kt">double</span> <span class="o">*</span> <span class="n">z</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">double</span><span class="p">[</span><span class="n">n</span><span class="p">];</span>
  <span class="kt">int</span> <span class="o">*</span> <span class="n">n0</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="p">[</span><span class="n">n</span><span class="p">];</span>
  <span class="kt">int</span> <span class="o">*</span> <span class="n">n1</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="p">[</span><span class="n">n</span><span class="p">];</span>
  <span class="kt">int</span> <span class="o">*</span> <span class="n">n2</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="p">[</span><span class="n">n</span><span class="p">];</span>
  <span class="n">Particle</span> <span class="o">**</span> <span class="n">particles</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Particle</span><span class="o">*</span><span class="p">[</span><span class="n">n</span><span class="p">];</span>
  <span class="n">ParticlesMapIterator</span> <span class="n">i</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  
  <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">particlesMap</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">particlesMap</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Particle</span> <span class="o">*</span> <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">i</span><span class="p">).</span><span class="n">second</span><span class="p">;</span>
    <span class="n">particles</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
    <span class="n">x</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">;</span>
    <span class="n">y</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">;</span>
    <span class="n">z</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">z</span><span class="p">;</span>
    
    <span class="n">c</span><span class="o">++</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="kt">int</span> <span class="n">errorcode</span> <span class="o">=</span> <span class="n">find_nearest_neighbors</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">n0</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="n">errorcode</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">errorcode</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="k">for</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Particle</span> <span class="o">*</span> <span class="n">p</span> <span class="o">=</span> <span class="n">particles</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
    
    <span class="n">p</span><span class="o">-&gt;</span><span class="n">n0</span> <span class="o">=</span> <span class="n">n0</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">particles</span><span class="p">[</span><span class="n">n0</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span><span class="o">-&gt;</span><span class="nl">index</span> <span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">p</span><span class="o">-&gt;</span><span class="n">n1</span> <span class="o">=</span> <span class="n">n1</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">particles</span><span class="p">[</span><span class="n">n1</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span><span class="o">-&gt;</span><span class="nl">index</span> <span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">p</span><span class="o">-&gt;</span><span class="n">n2</span> <span class="o">=</span> <span class="n">n1</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">particles</span><span class="p">[</span><span class="n">n2</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span><span class="o">-&gt;</span><span class="nl">index</span> <span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">get_nearest_neighbor</span><span class="p">(</span><span class="kt">int</span> <span class="n">index_of_the_particle</span><span class="p">,</span> 
  <span class="kt">double</span> <span class="o">*</span> <span class="n">index_of_the_neighbor</span><span class="p">,</span> <span class="kt">double</span> <span class="o">*</span> <span class="n">distance</span><span class="p">){</span>
  
  <span class="k">if</span><span class="p">(</span><span class="n">index_of_the_particle</span> <span class="o">&gt;</span> <span class="n">highest_index</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="n">Particle</span> <span class="o">*</span> <span class="n">p0</span> <span class="o">=</span> <span class="n">particlesMap</span><span class="p">[</span><span class="n">index_of_the_particle</span><span class="p">];</span>
  <span class="n">Particle</span> <span class="o">*</span> <span class="n">p1</span> <span class="o">=</span> <span class="n">particlesMap</span><span class="p">[</span><span class="n">p0</span><span class="o">-&gt;</span><span class="n">n0</span><span class="p">];</span>
  <span class="o">*</span><span class="n">index_of_the_neighbor</span>  <span class="o">=</span> <span class="n">p0</span><span class="o">-&gt;</span><span class="n">n0</span><span class="p">;</span>
  <span class="o">*</span><span class="n">distance</span> <span class="o">=</span> <span class="n">distance_between_points</span><span class="p">(</span><span class="n">p0</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">,</span> <span class="n">p0</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">,</span> <span class="n">p0</span><span class="o">-&gt;</span><span class="n">z</span><span class="p">,</span> <span class="n">p1</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">,</span> <span class="n">p1</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">,</span> <span class="n">p1</span><span class="o">-&gt;</span><span class="n">z</span><span class="p">);</span>
  
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">new_particle</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span> <span class="n">index_of_the_particle</span><span class="p">,</span> <span class="kt">double</span> <span class="n">x</span><span class="p">,</span> <span class="kt">double</span> <span class="n">y</span><span class="p">,</span> 
  <span class="kt">double</span> <span class="n">z</span><span class="p">){</span>
  
  <span class="o">*</span><span class="n">index_of_the_particle</span> <span class="o">=</span> <span class="n">highest_index</span><span class="p">;</span>
  
  <span class="n">Particle</span> <span class="o">*</span> <span class="n">p</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Particle</span><span class="p">(</span><span class="n">highest_index</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">);</span>
  <span class="n">particlesMap</span><span class="p">[</span><span class="n">highest_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
  
  <span class="n">highest_index</span><span class="o">++</span><span class="p">;</span>
  
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">get_close_neighbors</span><span class="p">(</span>
  <span class="kt">int</span> <span class="n">index_of_the_particle</span><span class="p">,</span> 
  <span class="kt">double</span> <span class="o">*</span> <span class="n">index_of_first_neighbor</span><span class="p">,</span> 
  <span class="kt">double</span> <span class="o">*</span> <span class="n">index_of_second_neighbor</span><span class="p">,</span> 
  <span class="kt">double</span> <span class="o">*</span> <span class="n">index_of_third_neighbor</span>
  <span class="p">){</span>

  <span class="k">if</span><span class="p">(</span><span class="n">index_of_the_particle</span> <span class="o">&gt;</span> <span class="n">highest_index</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="n">Particle</span> <span class="o">*</span> <span class="n">p</span> <span class="o">=</span> <span class="n">particlesMap</span><span class="p">[</span><span class="n">index_of_the_particle</span><span class="p">];</span>
  <span class="o">*</span><span class="n">index_of_first_neighbor</span>  <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">n0</span><span class="p">;</span>
  <span class="o">*</span><span class="n">index_of_second_neighbor</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">n1</span><span class="p">;</span>
  <span class="o">*</span><span class="n">index_of_third_neighbor</span>  <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">n2</span><span class="p">;</span>
  
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">delete_particle</span><span class="p">(</span><span class="kt">int</span> <span class="n">index_of_the_particle</span><span class="p">){</span>
  
  <span class="k">if</span><span class="p">(</span><span class="n">index_of_the_particle</span> <span class="o">&gt;</span> <span class="n">highest_index</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="n">particlesMap</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">index_of_the_particle</span><span class="p">);</span>
  
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">set_state</span><span class="p">(</span><span class="kt">int</span> <span class="n">index_of_the_particle</span><span class="p">,</span> <span class="kt">double</span> <span class="n">x</span><span class="p">,</span> <span class="kt">double</span> <span class="n">y</span><span class="p">,</span> <span class="kt">double</span> <span class="n">z</span><span class="p">){</span>
    
  <span class="k">if</span><span class="p">(</span><span class="n">index_of_the_particle</span> <span class="o">&gt;</span> <span class="n">highest_index</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="n">Particle</span> <span class="o">*</span> <span class="n">p</span> <span class="o">=</span> <span class="n">particlesMap</span><span class="p">[</span><span class="n">index_of_the_particle</span><span class="p">];</span>
  
  <span class="n">p</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-&gt;</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-&gt;</span><span class="n">z</span> <span class="o">=</span> <span class="n">z</span><span class="p">;</span>
  
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">get_state</span><span class="p">(</span><span class="kt">int</span> <span class="n">index_of_the_particle</span><span class="p">,</span> <span class="kt">double</span> <span class="o">*</span> <span class="n">x</span><span class="p">,</span> <span class="kt">double</span> <span class="o">*</span> <span class="n">y</span><span class="p">,</span> 
  <span class="kt">double</span> <span class="o">*</span> <span class="n">z</span><span class="p">){</span>
      
  <span class="k">if</span><span class="p">(</span><span class="n">index_of_the_particle</span> <span class="o">&gt;</span> <span class="n">highest_index</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="n">Particle</span> <span class="o">*</span> <span class="n">p</span> <span class="o">=</span> <span class="n">particlesMap</span><span class="p">[</span><span class="n">index_of_the_particle</span><span class="p">];</span>
  
  <span class="o">*</span><span class="n">x</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">;</span>
  <span class="o">*</span><span class="n">y</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">;</span>
  <span class="o">*</span><span class="n">z</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">z</span><span class="p">;</span>
  
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">get_number_of_particles</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span> <span class="n">value</span><span class="p">){</span>
  <span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">particlesMap</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Test if the code builds and try it out. In the legacy interface
directory do:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&gt; make clean
&gt; make all
&gt; nosetests
.
----------------------------------------------------------------------
Ran <span class="m">1</span> <span class="nb">test</span> in <span class="m">0</span>.311s

OK
</pre></div>
</div>
<p>Let’s check some more functionality by adding another test</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">instance</span> <span class="o">=</span> <span class="n">NearestNeighborInterface</span><span class="p">()</span>
    <span class="n">result</span><span class="p">,</span><span class="n">error</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">new_particle</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">result</span><span class="p">,</span><span class="n">error</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">new_particle</span><span class="p">(</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">result</span><span class="p">,</span><span class="n">error</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">new_particle</span><span class="p">(</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">error</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">delete_particle</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">result</span><span class="p">,</span><span class="n">error</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">new_particle</span><span class="p">(</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">instance</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</pre></div>
</div>
<p>The tests should succeed:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&gt; nosetests
..
----------------------------------------------------------------------
Ran <span class="m">2</span> tests in <span class="m">0</span>.448s

OK
</pre></div>
</div>
<p>We now have done everything in Step 0 <em>Legacy Interface</em>. We have
a legacy code and can access it in our python script. But, our
interface is not very friendly to work with. We have to think about
errorcodes and we have not information about units. To make our
interface easier to works with we start defining methods, properties
and parameters.</p>
</div>
<div class="section" id="defining-methods">
<h2>Defining methods<a class="headerlink" href="#defining-methods" title="Permalink to this headline">¶</a></h2>
<p>The object oriented interface is also defined in the <strong>interface.py</strong>.
So, we continue by opening an editor on this file. We will be
writing methods for the <strong>NearestNeighbor</strong> class, in your editor
seek this code (at the end of the file):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">NearestNeighbor</span><span class="p">(</span><span class="n">CodeInterface</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="n">CodeInterface</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">NearestNeighborInterface</span><span class="p">(),</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
</pre></div>
</div>
<p>We will start by defining methods, we will do this by implementing
the <strong>define_methods</strong> function, like so:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">NearestNeighbor</span><span class="p">(</span><span class="n">CodeInterface</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="n">CodeInterface</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">NearestNeighborInterface</span><span class="p">(),</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">define_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">builder</span><span class="p">):</span>

        <span class="n">builder</span><span class="o">.</span><span class="n">add_method</span><span class="p">(</span>
            <span class="s2">&quot;new_particle&quot;</span><span class="p">,</span>
            <span class="p">(</span><span class="n">generic_unit_system</span><span class="o">.</span><span class="n">length</span><span class="p">,</span> <span class="n">generic_unit_system</span><span class="o">.</span><span class="n">length</span><span class="p">,</span> <span class="n">generic_unit_system</span><span class="o">.</span><span class="n">length</span><span class="p">,),</span>
            <span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">INDEX</span><span class="p">,</span> <span class="n">builder</span><span class="o">.</span><span class="n">ERROR_CODE</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">builder</span><span class="o">.</span><span class="n">add_method</span><span class="p">(</span>
            <span class="s2">&quot;delete_particle&quot;</span><span class="p">,</span>
            <span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">INDEX</span><span class="p">,),</span>
            <span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">ERROR_CODE</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">builder</span><span class="o">.</span><span class="n">add_method</span><span class="p">(</span>
            <span class="s2">&quot;get_state&quot;</span><span class="p">,</span>
            <span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">INDEX</span><span class="p">,),</span>
            <span class="p">(</span><span class="n">generic_unit_system</span><span class="o">.</span><span class="n">length</span><span class="p">,</span> <span class="n">generic_unit_system</span><span class="o">.</span><span class="n">length</span><span class="p">,</span> <span class="n">generic_unit_system</span><span class="o">.</span><span class="n">length</span><span class="p">,</span> <span class="n">builder</span><span class="o">.</span><span class="n">ERROR_CODE</span><span class="p">),</span>
            <span class="n">public_name</span> <span class="o">=</span> <span class="s2">&quot;get_position&quot;</span>
        <span class="p">)</span>

        <span class="n">builder</span><span class="o">.</span><span class="n">add_method</span><span class="p">(</span>
            <span class="s2">&quot;set_state&quot;</span><span class="p">,</span>
            <span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">INDEX</span><span class="p">,</span> <span class="n">generic_unit_system</span><span class="o">.</span><span class="n">length</span><span class="p">,</span> <span class="n">generic_unit_system</span><span class="o">.</span><span class="n">length</span><span class="p">,</span> <span class="n">generic_unit_system</span><span class="o">.</span><span class="n">length</span><span class="p">,),</span>
            <span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">ERROR_CODE</span><span class="p">),</span>
            <span class="n">public_name</span> <span class="o">=</span> <span class="s2">&quot;set_position&quot;</span>
        <span class="p">)</span>

        <span class="n">builder</span><span class="o">.</span><span class="n">add_method</span><span class="p">(</span>
            <span class="s2">&quot;run&quot;</span><span class="p">,</span>
            <span class="p">(),</span>
            <span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">ERROR_CODE</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="n">builder</span><span class="o">.</span><span class="n">add_method</span><span class="p">(</span>
            <span class="s2">&quot;get_close_neighbors&quot;</span><span class="p">,</span>
            <span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">INDEX</span><span class="p">,),</span>
            <span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">LINK</span><span class="p">(</span><span class="s1">&#39;particles&#39;</span><span class="p">),</span> <span class="n">builder</span><span class="o">.</span><span class="n">LINK</span><span class="p">(</span><span class="s1">&#39;particles&#39;</span><span class="p">),</span> <span class="n">builder</span><span class="o">.</span><span class="n">LINK</span><span class="p">(</span><span class="s1">&#39;particles&#39;</span><span class="p">),</span> <span class="n">builder</span><span class="o">.</span><span class="n">ERROR_CODE</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="n">builder</span><span class="o">.</span><span class="n">add_method</span><span class="p">(</span>
            <span class="s2">&quot;get_nearest_neighbor&quot;</span><span class="p">,</span>
            <span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">INDEX</span><span class="p">,),</span>
            <span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">LINK</span><span class="p">(</span><span class="s1">&#39;particles&#39;</span><span class="p">),</span> <span class="n">generic_unit_system</span><span class="o">.</span><span class="n">length</span><span class="p">,</span> <span class="n">builder</span><span class="o">.</span><span class="n">ERROR_CODE</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="n">builder</span><span class="o">.</span><span class="n">add_method</span><span class="p">(</span>
            <span class="s2">&quot;get_number_of_particles&quot;</span><span class="p">,</span>
            <span class="p">(),</span>
            <span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">NO_UNIT</span><span class="p">,</span> <span class="n">builder</span><span class="o">.</span><span class="n">ERROR_CODE</span><span class="p">),</span>
        <span class="p">)</span>
</pre></div>
</div>
<p>With this code, we define the methods and specify how to interpret the
arguments and return values. We get a special object (the <strong>builder</strong>
object) that provides us with the <strong>add_method</strong> function to be able
to this. The definition of the <strong>add_method</strong> function is as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>add_method(
    name of the original function in the legacy interface,
    list of arguments (unit or type),
    list of return values,
    public_name = name for the user of the class (optional)
)
</pre></div>
</div>
<p>For every argument or return value we can specify if it has a unit or
if it is special. The special arguments are:</p>
<table border="1" class="docutils">
<colgroup>
<col width="32%" />
<col width="68%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">definition</th>
<th class="head">description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>builder.ERROR_CODE</td>
<td>the value is interpreted as an errorcode,
zero means no error for all other values and
Exception will be raise, only valid for one return value.</td>
</tr>
<tr class="row-odd"><td>builder.NO_UNIT</td>
<td>the value has not unit (for example for the
number of items in a list)</td>
</tr>
<tr class="row-even"><td>builder.INDEX</td>
<td>the value is interpreted as an index for
object identifiers</td>
</tr>
<tr class="row-odd"><td>builder.LINK(‘particles’)</td>
<td>the value is interpreted as a link to
objects in the set with the given name</td>
</tr>
</tbody>
</table>
<p>Test if the code builds and try it out. In the legacy interface
directory do:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">make</span> <span class="n">clean</span>
<span class="o">&gt;</span> <span class="n">make</span> <span class="nb">all</span>
</pre></div>
</div>
<p>Let’s add another test:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test3</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">instance</span> <span class="o">=</span> <span class="n">NearestNeighbor</span><span class="p">()</span>
    <span class="n">instance</span><span class="o">.</span><span class="n">set_maximum_number_of_particles</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">instance</span><span class="o">.</span><span class="n">commit_parameters</span><span class="p">()</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">new_particle</span><span class="p">(</span>
        <span class="mf">1.0</span> <span class="o">|</span> <span class="n">generic_unit_system</span><span class="o">.</span><span class="n">length</span><span class="p">,</span>
        <span class="mf">2.0</span> <span class="o">|</span> <span class="n">generic_unit_system</span><span class="o">.</span><span class="n">length</span><span class="p">,</span>
        <span class="mf">3.0</span> <span class="o">|</span> <span class="n">generic_unit_system</span><span class="o">.</span><span class="n">length</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">new_particle</span><span class="p">(</span>
        <span class="mf">1.0</span> <span class="o">|</span> <span class="n">generic_unit_system</span><span class="o">.</span><span class="n">length</span><span class="p">,</span>
        <span class="mf">1.0</span> <span class="o">|</span> <span class="n">generic_unit_system</span><span class="o">.</span><span class="n">length</span><span class="p">,</span>
        <span class="mf">2.0</span> <span class="o">|</span> <span class="n">generic_unit_system</span><span class="o">.</span><span class="n">length</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">get_position</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">|</span> <span class="n">generic_unit_system</span><span class="o">.</span><span class="n">length</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">|</span> <span class="n">generic_unit_system</span><span class="o">.</span><span class="n">length</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="mf">3.0</span> <span class="o">|</span> <span class="n">generic_unit_system</span><span class="o">.</span><span class="n">length</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
    <span class="n">instance</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</pre></div>
</div>
<p>And run the tests:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&gt; nosetests
...
----------------------------------------------------------------------
Ran <span class="m">3</span> tests in <span class="m">0</span>.664s

OK
</pre></div>
</div>
<p>As you can see our script is now a little simpler and we support units.
We do not have to think about the errorcodes in this script, AMUSE will
interpret the errorcodes and raise the right exceptions if needed. The
units are also automatically converted to the right units for the
code. But the script is still not very easy and we have to manage
all the ids we get from the code. To make our code even easier to
handle we will continue by defining a <strong>set</strong>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">We skip defining parameters and properties, we will come back to
this later in this tutorial.</p>
</div>
</div>
<div class="section" id="defining-a-set">
<h2>Defining a set<a class="headerlink" href="#defining-a-set" title="Permalink to this headline">¶</a></h2>
<p>We have made our interface a little easier but we still have to
do a some management work in our script. We would like to work
with objects and adding or removing these objects from the code.
AMUSE supports this by defining <strong>sets</strong>. Each set is capable of
storing specific attributes of the objects in the set. Our code
is capable of storing the x, y and z position of an object. An object
in AMUSE is called a <em>Particle</em> and the sets that contain these
particles are called <em>ParticleSets</em> or shorter <em>Particles</em>.</p>
<p>We define our particle set by implementing a <strong>define_particle_sets</strong>
function on our <strong>NearestNeighbor</strong> class like so:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">NearestNeighbor</span><span class="p">(</span><span class="n">InCodeComponentImplementation</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="n">InCodeComponentImplementation</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">NearestNeighborInterface</span><span class="p">(),</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">define_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">builder</span><span class="p">):</span>
        <span class="o">...</span>

    <span class="k">def</span> <span class="nf">define_particle_sets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">builder</span><span class="p">):</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">define_set</span><span class="p">(</span><span class="s1">&#39;particles&#39;</span><span class="p">,</span> <span class="s1">&#39;index_of_the_particle&#39;</span><span class="p">)</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">set_new</span><span class="p">(</span><span class="s1">&#39;particles&#39;</span><span class="p">,</span> <span class="s1">&#39;new_particle&#39;</span><span class="p">)</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">set_delete</span><span class="p">(</span><span class="s1">&#39;particles&#39;</span><span class="p">,</span> <span class="s1">&#39;delete_particle&#39;</span><span class="p">)</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">add_setter</span><span class="p">(</span><span class="s1">&#39;particles&#39;</span><span class="p">,</span> <span class="s1">&#39;set_position&#39;</span><span class="p">)</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">add_getter</span><span class="p">(</span><span class="s1">&#39;particles&#39;</span><span class="p">,</span> <span class="s1">&#39;get_position&#39;</span><span class="p">)</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">add_getter</span><span class="p">(</span><span class="s1">&#39;particles&#39;</span><span class="p">,</span> <span class="s1">&#39;get_close_neighbors&#39;</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;neighbor0&#39;</span><span class="p">,</span> <span class="s1">&#39;neighbor1&#39;</span><span class="p">,</span> <span class="s1">&#39;neighbor2&#39;</span><span class="p">)</span> <span class="p">)</span>
</pre></div>
</div>
<p>That’s all, we now have defined a set called <strong>particles</strong>. Again, we
get a builder object to use in defining our set. All methods have
the name of the set as their first argument, this name can be any
name you want, but in AMUSE most codes provide a set called
<strong>particles</strong>. For the <strong>add_setter</strong>, <strong>add_getter</strong>, <strong>set_new</strong>
and <strong>set_delete</strong> functions, the second argument is the name of
the method we defined in the previous step. Finally you can set
the name of the attribute in the particles set with the <strong>names</strong>
argument. This is optional for legacy functions, if not given the names
of the attributes will be derived from the names of the arguments in
the original calls. For example, the <strong>get_position</strong> call we specified
earlier has parameter name <strong>x</strong>, <strong>y</strong> and <strong>z</strong>, these names are
also used in the particles set.</p>
<p>Test if the code builds and try it out. In the legacy interface
directory do:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">make</span> <span class="n">clean</span>
<span class="o">&gt;</span> <span class="n">make</span> <span class="nb">all</span>
</pre></div>
</div>
<p>Let’s add another test:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test4</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">instance</span> <span class="o">=</span> <span class="n">NearestNeighbor</span><span class="p">()</span>
    <span class="n">instance</span><span class="o">.</span><span class="n">set_maximum_number_of_particles</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">instance</span><span class="o">.</span><span class="n">commit_parameters</span><span class="p">()</span>

    <span class="n">particles</span> <span class="o">=</span> <span class="n">datamodel</span><span class="o">.</span><span class="n">Particles</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">particles</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">]</span> <span class="o">|</span> <span class="n">generic_unit_system</span><span class="o">.</span><span class="n">length</span>
    <span class="n">particles</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="o">|</span> <span class="n">generic_unit_system</span><span class="o">.</span><span class="n">length</span>
    <span class="n">particles</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="o">|</span> <span class="n">generic_unit_system</span><span class="o">.</span><span class="n">length</span>

    <span class="n">instance</span><span class="o">.</span><span class="n">particles</span><span class="o">.</span><span class="n">add_particles</span><span class="p">(</span><span class="n">particles</span><span class="p">)</span>
    <span class="n">instance</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">particles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">neighbor0</span><span class="p">,</span> <span class="n">instance</span><span class="o">.</span><span class="n">particles</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">particles</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">neighbor0</span><span class="p">,</span> <span class="n">instance</span><span class="o">.</span><span class="n">particles</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">particles</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">neighbor0</span><span class="p">,</span> <span class="n">instance</span><span class="o">.</span><span class="n">particles</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">particles</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">neighbor0</span><span class="p">,</span> <span class="n">instance</span><span class="o">.</span><span class="n">particles</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

    <span class="n">instance</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</pre></div>
</div>
<p>The support for a particle set means we can now also interact
with other parts of AMUSE. Let’s make a plummer
model and find the nearest neighbors in this model.</p>
<p>First make a file with the following contents, let’s call this file
<strong>plummer2.py</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">interface</span> <span class="kn">import</span> <span class="n">NearestNeighbor</span>
<span class="kn">from</span> <span class="nn">amuse.lab</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">amuse.io</span> <span class="kn">import</span> <span class="n">text</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">number_of_particles</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="n">particles</span> <span class="o">=</span> <span class="n">new_plummer_sphere</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>

    <span class="n">code</span> <span class="o">=</span> <span class="n">NearestNeighbor</span><span class="p">()</span>
    <span class="n">code</span><span class="o">.</span><span class="n">particles</span><span class="o">.</span><span class="n">add_particles</span><span class="p">(</span><span class="n">particles</span><span class="p">)</span>

    <span class="n">code</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="n">local_particles</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">particles</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="n">local_particles</span><span class="o">.</span><span class="n">neighbor1</span><span class="o">.</span><span class="n">as_set</span><span class="p">()</span><span class="o">.</span><span class="n">position</span> <span class="o">-</span> <span class="n">local_particles</span><span class="o">.</span><span class="n">position</span>
   
    <span class="n">local_particles</span><span class="o">.</span><span class="n">dx</span> <span class="o">=</span> <span class="n">delta</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">local_particles</span><span class="o">.</span><span class="n">dy</span> <span class="o">=</span> <span class="n">delta</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">local_particles</span><span class="o">.</span><span class="n">dz</span> <span class="o">=</span> <span class="n">delta</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">output</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">TableFormattedText</span><span class="p">(</span><span class="s2">&quot;output.txt&quot;</span><span class="p">,</span> <span class="nb">set</span> <span class="o">=</span> <span class="n">local_particles</span><span class="p">)</span>
    <span class="n">output</span><span class="o">.</span><span class="n">attribute_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="s1">&#39;dx&#39;</span><span class="p">,</span> <span class="s1">&#39;dy&#39;</span><span class="p">,</span><span class="s1">&#39;dz&#39;</span><span class="p">]</span>
    <span class="n">output</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

</pre></div>
</div>
<p>We can run this file with python:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">..</span> <span class="n">code</span><span class="o">-</span><span class="n">block</span><span class="p">::</span> <span class="n">bash</span>
</pre></div>
</div>
<blockquote>
<div>$AMUSE_DIR/amuse.sh plummer2.py</div></blockquote>
<p>It will create an <strong>output.txt</strong> file and we can show this file
with gnuplot.</p>
<div class="highlight-gnuplot notranslate"><div class="highlight"><pre><span></span>gnuplot&gt; splot &#39;output.txt&#39; using 1:2:3:4:5:6 with vectors nohead, &#39;output.txt&#39; using 1:2:3
gnuplot&gt; #we can zoom into the center
gnuplot&gt; set xr[-0.5:0.5]
gnuplot&gt; set yr[-0.5:0.5]
gnuplot&gt; set zr[-0.5:0.5]
gnuplot&gt; splot &#39;output.txt&#39; using 1:2:3:4:5:6 with vectors nohead, &#39;output.txt&#39; using 1:2:3
</pre></div>
</div>
<img alt="../_images/plummer1.png" src="../_images/plummer1.png" />
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="fortran_code.html" class="btn btn-neutral float-right" title="Integrate a Fortran 90 code" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="particle_sets.html" class="btn btn-neutral float-left" title="Working with Particle Sets" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2009-2019 The AMUSE Team

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
  
    <!-- Piwik -->
<script type="text/javascript">
var pkBaseURL = (("https:" == document.location.protocol) ? "https://stats.amusecode.org/" : "http://stats.amusecode.org/");
document.write(unescape("%3Cscript src='" + pkBaseURL + "piwik.js' type='text/javascript'%3E%3C/script%3E"));
</script><script type="text/javascript">
try {
var piwikTracker = Piwik.getTracker(pkBaseURL + "piwik.php", 1);
piwikTracker.trackPageView();
piwikTracker.enableLinkTracking();
} catch( err ) {}
</script><noscript><p><img src="http://stats.amusecode.org/piwik.php?idsite=1" style="border:0" alt="" /></p></noscript>
<!-- End Piwik Tracking Code -->

     


</body>
</html>