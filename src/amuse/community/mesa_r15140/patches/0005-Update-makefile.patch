From 98a01af68bdc0579e4656bbfe45e38a3afa8203e Mon Sep 17 00:00:00 2001
From: Robert Farmer <r.j.farmer@uva.nl>
Date: Tue, 16 Feb 2021 11:57:57 +0100
Subject: [PATCH 5/6] Update makefile

---
 utils/makefile_header_non_mesasdk | 160 +++++++++++++-----------------
 1 file changed, 67 insertions(+), 93 deletions(-)

diff --git a/utils/makefile_header_non_mesasdk b/utils/makefile_header_non_mesasdk
index 15b2268..cdba83a 100644
--- a/utils/makefile_header_non_mesasdk
+++ b/utils/makefile_header_non_mesasdk
@@ -17,14 +17,13 @@ endif
 # NOTE: recent versions of mesa have required reduced optimization 
 # in order to work with ifort; we suggest using gfortran instead of ifort if possible.
 
-CC = gcc
-FC = ifort
-#FC = gfortran
+CC = $(MPICC)
+FC =  $(MPIFC)
 
 
 # if you need special flags for the compiler, define them here:
-SPECIAL_FC_FLAGS = 
-SPECIAL_C_FLAGS = 
+SPECIAL_FC_FLAGS = $(cflags)
+SPECIAL_C_FLAGS = $(fflags)
 
 # step 1.a) [temporary workaround for loader problem on Mac:] 
 #           go down to select the correct entry for LOAD_MATRIX 
@@ -35,7 +34,8 @@ SPECIAL_C_FLAGS =
 USE_CRMATH = YES
 
 ifeq ($(USE_CRMATH),YES)
-LOAD_CRMATH = -lcrmath -lcrlibm
+LOAD_CRMATH = -L$(MESA_DIR)/lib -lcrmath -lcrlibm
+export MESASDK_MATH_SLOT = crmath
 INCLUDE_CRMATH = 
 endif
 
@@ -110,8 +110,8 @@ ifneq (,$(findstring gfortran,$(FC)))
 
 #USE_PGSTAR = NO
 #LOAD_PGPLOT = 
-USE_PGSTAR = YES
-LOAD_PGPLOT = -L/Users/bpaxton/mesa/utils/pgplot_gfortran -lpgplot -L/usr/X11R6/lib -lX11 -lpng
+USE_PGSTAR = NO
+LOAD_PGPLOT = 
 
 else
 
@@ -152,13 +152,13 @@ endif
 # export LD_LIBRARY_PATH=$MESA_DIR/utils/hdf5/lib:$LD_LIBRARY_PATH
 
 # These are if you are using the sdk hdf5 implementation
-LOAD_HDF5 = `mesasdk_hdf5_link`
-INCLUDE_HDF5 = -I${MESASDK_ROOT}/include
+LOAD_HDF5 = -L/usr/lib64 -lhdf5_fortran -lhdf5 -lz
+INCLUDE_HDF5 = -I/usr/lib64/gfortran/modules/
 
 # If not YES then we don't use HDF5, thus you wont have access to custom weak rates
 # Also the rates test suite will not pass so do: /usr/bin/touch $MESA_DIR/rates/skip_test
 # if you change this option
-USE_HDF5 = NO
+USE_HDF5 = YES
 
 
 # step 6) now do the mesa install
@@ -179,34 +179,35 @@ USE_SHARED = NO
 # It simply defines things for use by the module makefiles.
 
 
-ifneq (,$(findstring ifort,$(FC)))
-
-#FCbasic = $(SPECIAL_FC_FLAGS) -assume protect-parens -fp-model source -prec-div -prec-sqrt -ftz -traceback -error-limit 6
-FCbasic = $(SPECIAL_FC_FLAGS) -assume protect-parens -fp-model source -prec-div -prec-sqrt -traceback -error-limit 6
-
-# use -vec-report2 to check on vectorization
-
-FCimpno = -implicitnone 
-FCchecks = -check uninit -check pointers -check bounds -check all
-FCwarn = -warn all -warn nounused
-FCwarn_unused = -warn unused
-FC_fixed_preprocess = -fpp
-FC_free_preprocess = -fpp
-FCfixed = -fixed -132 $(FC_fixed_preprocess)
-FCfixed72 = -fixed $(FC_fixed_preprocess)
-FCfree = -free $(FC_free_preprocess)
-FCopt = -O1
-FCdebug = -g
-SLOW_COMPILE = 
-ifeq ($(USE_OPENMP),YES)
-FCopenmp = -qopenmp -threads
-else
-FCopenmp = 
-endif
-FCstatic =
-
-else
-ifneq (,$(findstring gfortran,$(FC)))
+# ifneq (,$(findstring ifort,$(FC)))
+
+# #FCbasic = $(SPECIAL_FC_FLAGS) -assume protect-parens -fp-model source -prec-div -prec-sqrt -ftz -traceback -error-limit 6
+# FCbasic = $(SPECIAL_FC_FLAGS) -assume protect-parens -fp-model source -prec-div -prec-sqrt -traceback -error-limit 6
+
+# # use -vec-report2 to check on vectorization
+
+# FCimpno = -implicitnone 
+# FCchecks = -check uninit -check pointers -check bounds -check all
+# FCwarn = -warn all -warn nounused
+# FCwarn_unused = -warn unused
+# FC_fixed_preprocess = -fpp
+# FC_free_preprocess = -fpp
+# FCfixed = -fixed -132 $(FC_fixed_preprocess)
+# FCfixed72 = -fixed $(FC_fixed_preprocess)
+# FCfree = -free $(FC_free_preprocess)
+# FCopt = -O1
+# FCdebug = 
+# SLOW_COMPILE = 
+# OPENMP_FCFLAGS ?= -openmp
+# ifeq ($(USE_OPENMP),YES)
+# FCopenmp = -g $(OPENMP_FCFLAGS) -threads
+# else
+# FCopenmp = 
+# endif
+# FCstatic =
+
+# else
+# ifneq (,$(findstring gfortran,$(FC)))
 
 FCbasic = -Wno-uninitialized -fno-range-check -fmax-errors=100 $(SPECIAL_FC_FLAGS) $(FCbasic2)
 FCbasic2 = -fprotect-parens -fno-sign-zero -fbacktrace -ggdb -finit-real=snan
@@ -226,25 +227,26 @@ FCopt = -O2 -ftree-vectorize
 FCdebug = -ggdb
 FCstatic =
 SLOW_COMPILE = -fno-var-tracking
+OPENMP_FCFLAGS ?= -fopenmp
 ifeq ($(USE_OPENMP),YES)
-FCopenmp = -fopenmp
+FCopenmp = $(OPENMP_FCFLAGS)
 else
 FCopenmp = 
 endif
 
-else
+# else
 
-FCbasic = UNKNOWN COMPILER
-FCchecks =
-FCwarn = 
-FCfixed =
-FCfree =
-FCopt = 
-FCdebug = 
-FCopenmp = 
-SLOW_COMPILE = 
-endif
-endif
+# FCbasic = UNKNOWN COMPILER
+# FCchecks =
+# FCwarn = 
+# FCfixed =
+# FCfree =
+# FCopt = 
+# FCdebug = 
+# FCopenmp = 
+# SLOW_COMPILE = 
+# endif
+# endif
 
 LIB_TOOL_STATIC = ar crs
 LIB_SUFFIX_STATIC = a
@@ -280,41 +282,15 @@ else
    LIBS =
 endif
 
-
 # some definitions used in the module makefiles
 MODULE_DIR = ..
 MOD_PUBLIC_DIR = $(MODULE_DIR)/public
 MOD_PRIVATE_DIR = $(MODULE_DIR)/private
 MODULE_INCLUDES = -I$(MOD_PUBLIC_DIR) -I$(MOD_PRIVATE_DIR)
-OTHER_INCLUDES = -I$(MESA_DIR)/include
-INCLUDES = $(MODULE_INCLUDES) $(OTHER_INCLUDES)
-
-COMPILE_BASIC_FLAGS = $(FCbasic) $(FCopenmp) $(FCstatic) $(INCLUDES)
-COMPILE_BASIC = $(FC) $(COMPILE_BASIC_FLAGS)
-
-COMPILE_TO_TEST   = $(COMPILE_BASIC) $(FCwarn) $(FCimpno) $(FCchecks) $(FCopt) $(FCdebug) -c
-COMPILE_TO_DEPLOY = $(COMPILE_BASIC) $(FCwarn) $(FCimpno) $(FCopt) -c
-
-COMPILE_NO_OPENMP_NO_OPT = \
-   $(FC) $(FCbasic) $(INCLUDES) $(FCwarn) $(FCimpno) $(FCchecks) $(FCdebug) -c -O
-COMPILE_ASAP = \
-   $(FC) $(FCbasic) $(INCLUDES) $(FCwarn) $(FCimpno) $(FCdebug) -c -O
-
-COMPILE_FAST = $(COMPILE_BASIC) -c
-COMPILE_NO_CHECKS = $(COMPILE_BASIC) $(FCopt) -c
-COMPILE_NO_OPT    = $(COMPILE_BASIC) $(FCwarn) $(FCimpno) $(FCchecks) $(FCdebug) -c -O
-COMPILE_DEVEL     = $(COMPILE_NO_OPT)
-
-
-# some definitions used in the module makefiles
-MODULE_DIR = ..
-MOD_PUBLIC_DIR = $(MODULE_DIR)/public
-MOD_PRIVATE_DIR = $(MODULE_DIR)/private
-MODULE_INCLUDES = -I$(MOD_PUBLIC_DIR) -I$(MOD_PRIVATE_DIR)
-OTHER_INCLUDES = -I$(MESA_DIR)/include $(INCLUDE_HDF5) $(INCLUDE_CRMATH)
+OTHER_INCLUDES = -I$(MESA_DIR)/include $(INCLUDE_HDF5)
 INCLUDES = $(MODULE_INCLUDES) $(OTHER_INCLUDES) 
 
-COMPILE_BASIC_FLAGS = $(FCbasic) $(FCopenmp) $(FCstatic) $(LIB_FLAGS) $(INCLUDES) $(LIB_FLAGS)
+COMPILE_BASIC_FLAGS = $(FCbasic) $(FCopenmp) $(FCstatic) $(FCstandard) $(LIB_FLAGS) $(INCLUDES)
 COMPILE_BASIC = $(FC) $(COMPILE_BASIC_FLAGS)
 
 COMPILE_TO_TEST   = $(COMPILE_BASIC) $(FCwarn) $(FCimpno) $(FCchecks) $(FCopt) $(FCdebug) -c
@@ -330,22 +306,22 @@ COMPILE_NO_CHECKS = $(COMPILE_BASIC) $(FCopt) -c
 COMPILE_NO_OPT    = $(COMPILE_BASIC) $(FCwarn) $(FCimpno) $(FCchecks) $(FCdebug) -c -O
 COMPILE_DEVEL     = $(COMPILE_NO_OPT)
 
+
 # some definitions used in the test makefiles and client makefiles
 
 WORK_COMPILE = \
-   $(FC) $(FCbasic) $(FCopenmp) -O0 $(FCchecks) $(FCdebug) $(FCfree) \
-   $(FC_free_preprocess) -I$(MESA_INCLUDE_DIR) $(INCLUDE_HDF5) -c
- 
+   $(FC) $(FCbasic) $(FCopenmp) $(FCchecks) $(FCdebug) $(FCfree) \
+   -I$(MESA_INCLUDE_DIR) -I$(WORK_SRC_DIR) -c
+
 ifeq ($(USE_PGPLOT),YES)
 	WORK_COMPILE += -DUSE_PGPLOT
 endif
- 
+
 TEST_DIR = ..
 TEST_SRC_DIR = $(TEST_DIR)/src
 PACKAGE_DIR = ../..
 LOCAL_LIB_DIR = $(PACKAGE_DIR)/make
 MESA_LIB_DIR = $(MESA_DIR)/lib
-
 MESA_INCLUDE_DIR = $(MESA_DIR)/include
 TEST_INCLUDES = -I$(LOCAL_LIB_DIR) -I$(PACKAGE_DIR)/public -I$(MESA_INCLUDE_DIR)
 TEST_COMPILE_FLAGS = $(FCbasic) $(FCopenmp) $(TEST_INCLUDES) $(FCchecks) $(FCdebug) $(LIB_FLAGS) -c
@@ -355,7 +331,7 @@ TEST_COMPILE = $(FC) $(TEST_COMPILE_FLAGS) $(LD_FLAGS)
 
 LIBS_MATRIX = mtx const math utils
 LOAD_MATRIX_INT = $(addprefix -l,$(LIBS_MATRIX))
-LOAD_MATRIX_EXT = $(LOAD_CRMATH) $(LOAD_LAPACK) $(LOAD_BLAS)
+LOAD_MATRIX_EXT = $(LOAD_CRMATH) $(LOAD_LAPACK95) $(LOAD_LAPACK) $(LOAD_BLAS)
 LOAD_MATRIX = $(LOAD_MATRIX_INT) $(LOAD_MATRIX_EXT)
 
 LIBS_MESA_NUMERICS = interp_2d interp_1d num auto_diff $(LIBS_MATRIX)
@@ -388,7 +364,7 @@ LOAD_MESA_STAR_INT = -L$(MESA_LIB_DIR) $(addprefix -l,$(LIBS_MESA_STAR))
 ifeq ($(USE_PGSTAR),YES)
    LOAD_MESA_STAR_EXT = $(LOAD_STAR_MODS_EXT) $(LOAD_PGPLOT)
 else
-   LOAD_MESA_STAR_EXT = $(LOAD_STAR_MODS_EXT) $(LOAD_PGPLOT)
+   LOAD_MESA_STAR_EXT = $(LOAD_STAR_MODS_EXT) 
 endif
 LOAD_MESA_STAR = $(LOAD_MESA_STAR_INT) $(LOAD_MESA_STAR_EXT)
 
@@ -420,10 +396,8 @@ CP_IF_NEWER = $(MESA_DIR)/utils/cp_if_newer
 
 # makedepf90 invocation (depends on whether we have the SDK2-patched version that
 # supports the -X flag)
-ifneq ($(shell makedepf90 -V | grep sdk2),)
-    MAKEDEPF90_IGNORE_MODS = intrinsic omp_lib iso_c_binding iso_fortran_env crmath hdf5
-    MAKEDEPF90 = makedepf90 -m %m.mod -X $(addprefix -u,$(MAKEDEPF90_IGNORE_MODS))
-else
-    MAKEDEPF90 = makedepf90 -m %m.mod
-endif
+MAKEDEPF90 := $(MESA_DIR)/utils/makedepf90-2.8.8/makedepf90 -m %m.mod
+
+
+
     
-- 
2.29.2

